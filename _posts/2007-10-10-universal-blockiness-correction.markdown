---

title: Universal blockiness correction
abstract: Techniques to remove inherited blockiness with a low million instructions per second (MIPs) are provided. In one configuration, a device comprises a processor operative to implement a set of instructions to universally correct blockiness. The processor commandeers the in-loop deblocking filtering engine and universally corrects blockiness, including inherited blockiness, using the in-loop deblocking filtering engine.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08619880&OS=08619880&RS=08619880
owner: QUALCOMM Incorporated
number: 08619880
owner_city: San Diego
owner_country: US
publication_date: 20071010
---
The present disclosure relates generally to the field of image processing and more specifically to techniques for universally correcting blockiness with a low million instructions per second MIPs .

Blockiness is one of the most noticeable artifacts introduced by block based video and image coding. The reasons behind the blockiness is that the block based coding uses a block e.g. 8 8 or 4 4 as a basic unit for transformation quantization and texture coding and the inter block correlation is lost during this coding. The problem is especially severe when video image content is coded at very low bit rates high quantization step size qp . For intra macroblocks MBs the blocking artifacts are visible only around block boundaries. However for inter MBs the motion compensation may bring the artifacts inside the blocks. The blocking artifacts coming from the reference frames is termed inherited blockiness because the blockiness is inherited from previous frames. The inherited blockiness may be visible at any location and have any length.

There are two types of approaches to address the inherited blockiness issue. A first approach is to exploit long tap filtering on all pixels in order to smooth out artifacts because the inherited blockiness may appear anywhere. The first approach employs the DC offset mode defined in the motion picture expert group MPEG 4 standard in which a 9 tap filtering is applied on all eight neighboring pixels around a block edge. The second approach traces the moving trajectory of the blockiness and applies DB on the moved artifacts.

The second approach has been proved to be an effective tool to remove inherited blockiness the MIPs requirement for deblocking a 30 frames per second fps VGA image is too high for mobile or wireless applications.

Using a H.264 hardware deblocker DB as a post loop deblocker for MPEG 4 and Wireless Media Video 9 series WMV9 is known. However in the past the post loop deblocker only filters the pixels around 8 8 blocks so the inherited blockiness still remains. Furthermore the filtering strength for skipped MBs and coded block pattern CBP 0 blocks is not strong enough. The standard practice always sets BS for an inter MB as two or less unless the neighboring MB is of intra .

There is therefore a need for techniques to universally correct blockiness including inherited blockiness with a low million instructions per second MIPs .

Techniques to universally correct blockiness with a low million instructions per second MIPs are described herein. In one configuration a device comprising a processor operative to implement a set of instructions to commandeer an in loop deblocking filtering engine and to universally correct blockiness in a decoded output signal during a post loop filtering operation using the in loop deblocking filtering engine is provided. The device also includes a memory coupled to the processor.

In another aspect an integrated circuit comprising a decoder having an in loop deblocking filtering engine is provided. The integrated circuit also includes a processor operative to implement a set of instructions to commandeer the in loop deblocking filtering engine and to universally correct blockiness in a decoded output signal during a post loop filtering operation using the in loop deblocking filtering engine. The integrated circuit further includes a memory coupled to the processor.

In a still further aspect a computer program product including a computer readable medium having instructions for causing a computer to commandeer an in loop deblocking filtering engine is provided. The instructions further cause the computer to universally correct blockiness in a decoded output signal during a post loop filtering operation using the in loop deblocking filtering engine.

Additional aspects will become more readily apparent from the detailed description particularly when taken together with the appended drawings.

The images in the drawings are simplified for illustrative purposes and are not depicted to scale. To facilitate understanding identical reference numerals have been used where possible to designate identical elements that are common to the figures except that suffixes may be added when appropriate to differentiate such elements.

The appended drawings illustrate exemplary configurations of the invention and as such should not be considered as limiting the scope of the invention that may admit to other equally effective configurations. It is contemplated that features or steps of one configuration may be beneficially incorporated in other configurations without further recitation.

The word exemplary is used herein to mean serving as an example instance or illustration. Any configuration or design described herein as exemplary is not necessarily to be construed as preferred or advantageous over other configurations or designs and the terms core engine machine processor and processing unit are used interchangeably.

The techniques described herein may be used for wireless communications computing personal electronics etc. An exemplary use of the techniques for wireless communication is described below.

The wireless device is capable of providing bi directional communications via a receive path and a transmit path. On the receive path signals transmitted by base stations are received by an antenna and provided to a receiver RCVR . The receiver conditions and digitizes the received signal and provides samples to a digital section for further processing. On the transmit path a transmitter TMTR receives data to be transmitted from the digital section processes and conditions the data and generates a modulated signal which is transmitted via the antenna to the base stations.

The digital section includes various processing interface and memory units such as for example a modem processor a video processor a controller processor a display processor an ARM DSP a graphics processing unit GPU an internal memory and an external bus interface EBI . The modem processor performs processing for data transmission and reception e.g. encoding modulation demodulation and decoding . The video processor performs processing on video content e.g. still images moving videos and moving texts for video applications such as camcorder video playback and video conferencing. The controller processor may direct the operation of various processing and interface units within digital section . The display processor performs processing to facilitate the display of videos graphics and texts on a display unit . The ARM DSP may perform various types of processing for the wireless device . The graphics processing unit performs graphics processing.

The techniques described herein may be used for any of the processors in the digital section e.g. the video processor . The internal memory stores data and or instructions for various units within the digital section . The EBI facilitates the transfer of data between the digital section e.g. internal memory and a main memory along a bus or data line DL.

The digital section may be implemented with one or more DSPs micro processors RISCs etc. The digital section may also be fabricated on one or more application specific integrated circuits ASICs or some other type of integrated circuits ICs .

The techniques described herein may be implemented in various hardware units. For example the techniques may be implemented in ASICs DSPs RISCs ARMs digital signal processing devices DSPDs programmable logic devices PLDs field programmable gate arrays FPGAs processors controllers micro controllers microprocessors and other electronic units.

Furthermore the techniques described herein to remove blockiness artifacts introduced by video coding can be used for MPEG 4 H.263 WMV9 and H.264 standards. As can be seen from the description below the advantage of these techniques is that annoying inherited artifacts are removed at a very low cost such as 2.5 4 million instructions per second MIPs . The requirements for the new post loop de artifact blocker DAB apparatus for a low complexity configuration with almost 0 CPU usage for an ARM and reasonable DSP MIPs can be achieved with no module put in an ARM and with no pixel access. Moreover the real filtering is performed in DSP.

In the exemplary configuration the only filter used is the H.264 in loop deblocker DB because it is built in hardware HW . The exemplary configuration requires new boundary strength BS calculations in addition to the FilterOffsetA and FilterOffsetB defined in H.264 standard.

For clarity a tile is defined herein to prevent any confusion brought by different definitions for a block in different standards. In this disclosure a tile is defined as a 4 4 non overlap square and a block is defined as an 8 8 non overlapped square.

To prevent blur of the true edges three spatial activity checking conditions defined in equations Eq. 1 3 are specified in the H.264 standard to make a filtering decision. The H.264 standard assumes that the blockiness has a weaker amplitude difference than a true edge. Hence more taps of filtering on more pixels are performed when all the three conditions hold true as set forth in equations Eq. 1 3 . 1 FilterOffset 1 2 FilterOffset and 2 2 FilterOffset 3 where P P Pand Pare pixels qp is the quantization step size FilterOffsetA is a pre defined constant to adjust Thd1 FilterOffsetB is a pre defined constant to adjust Thd2 Thd1 is a threshold value for a corresponding qp and FilterOffsetA and Thd2 is a threshold value for a corresponding qp and FilterOffsetB. The values of FilterOffsetA and FilterOffsetB affect Thd1 and Thd2 and thus affect the pixels to be filtered.

The weak filtering operation referring to BS 1 2 and 3 modifies up to 4 luma pixels and up to 2 chroma pixels for a tile edge as described in Table 2. In Table 2 the symbol Y denotes filtering and N denotes no filtering.

For illustrative purposes the decoder includes a decoder hardware portion and a firmware software or a combination thereof portion for decoding input signals. The decoder hardware portion of a decoder includes a motion compensation module and a texture decoding module . The motion compensation module receives a data stream as input from a bit parser and receives a reference frame from the in loop deblocking filter engine A during in loop filtering operations. The motion compensation module also generates an output signal which is sent to the texture decoding module . The texture decoding module in turn generates an output signal which is sent to the in loop deblocking filter engine A. The in loop deblocking filter engine A produces a filtered output which includes a reference frame for input to the motion compensation module and a filtered output hereinafter referred to as the in loop filtered output . The dashed line denoted as includes the software firmware or a combination thereof for performing decoding operations in accordance with a codec procedure.

During the post loop DAB filtering operations the post loop de artifact blocker DAB apparatus commandeers the in loop deblocking filter engine A wherein the in loop filtered output is cycled back through the in loop deblocking filter engine A for post loop filtering operations under the control of the post loop DAB unit described later in detail.

Post loop filtering occurs after the decoder decoding and the filtered frames are not used as reference frames for the decoder . Since the post loop filtering is not defined in the codec standards one has freedom to design its own filter. If the in loop filtering operations are part of the decoder such operations need to be completely compliant with the codec standards.

For illustrative purposes the decoder includes a decoder hardware portion and a firmware software or a combination thereof portion for decoding input signals. The decoder hardware portion of a decoder includes a motion compensation module and a texture decoding module . The motion compensation module receives a data stream as input from a bit parser and receives a reference frame from the texture decoding module during decoding operations. The motion compensation module also generates an output signal which is sent to the texture decoding module . The texture decoding module generates a decoded output signal. The dashed line denoted as includes the software firmware or a combination thereof for performing decoding operations in accordance with a codec procedure without in loop filtering.

During the post loop DAB filtering operations the post loop de artifact blocker DAB apparatus commandeers the in loop deblocking filter engine B wherein the decoded output signal of the texture decoding module is cycled through the in loop deblocking filter engine B for post loop filtering operations under the control of the post loop DAB unit .

The post loop DAB parameters changing module includes a set post loop DAB parameters interface to provide setting of a plurality of DAB parameters. The plurality of DAB parameter includes a plurality of qp thresholds. The qp thresholds include intra mb qp thd0 inter mb qp thd boundary0 inter mb qp thd inside 0 inter mb qp thd boundary4 inter mb qp thd inside4. Additional parameters include qp jump for not coded block and num not coded blocks thd. Both the post loop DAB strength changing module and the post loop DAB parameters changing module are optional denoted by the dotted boxes in . The relationship between the qp thresholds and the filtering strength is shown in .

The qp thresholds are tunable. The single parameter post db strength controls all five qp thresholds. A small post db strength is associated with larger qp thresholds which raises the bar to do filtering. In the exemplary configuration the parameter post db strength ranges from 0 to 20 and 14 is a default value.

The input parameters for the post loop DAB procedure module include inter mb qp mb num x MB number along horizontal direction mb num y MB number along vertical direction not coded skipped and CBP coded block pattern . The parameter not coded skipped is a flag to indicate if the MB is not coded. If the flag is set the MB is not coded. Hence motion vector and texture information are not carried in bitstream. The MB is reconstructed by motion compensation with motion vector default motion vector. It should be noted that a default motion vector is defined differently for different codecs. The parameter coded block pattern CPB is a set of flags where each flag is used to indicate if the corresponding block in a MB is coded. A value 0 designates that the corresponding block note here the unit is block rather than MB is not coded and thus no texture information is in bitstream.

In various configurations below flowchart blocks are performed in the depicted order or these blocks or portions thereof may be performed contemporaneously in parallel or in a different order.

A new set of rule for the BS decision process based on coding parameters MB Type qp etc. are substituted. As mentioned previously boundary strength BS is directly linked to the filtering strength. A strong filtering operation is exploited when BS 4 a weak filtering operation is exploited when BS 1 2 or 3 and no filtering operation is exploited when BS 0. In the exemplary configuration three boundary strengths are used which include 4 2 or 0.

Ideally content is also an important factor for the BS decision process. A strong filtering operation may be used in smooth regions because artifacts are more visible in smooth areas. However a low complexity implementation prevents the configuration of the apparatus to have pixel access. Thus there is no way to have a content analysis module under some existing architectures besides the simple spatiality activity checking in HW .

In the block is shown for illustrative purposes and generally denotes that a decision is made whether the MB is an Inter MB. If the current MB is an Inter MB a determination is made whether the inter MB is a skipped MB at block . If the determination at block is No then block is followed by block where a determination is made whether the MB is a CBP. If the decisions at blocks and are both No meaning that the MB is not a skipped MB or a CBP MB then process proceeds to the post loop DAB inter MB procedure as shown in . However if the decision at block or block is Yes the process reduces the qp thresholds and FilterOffsetA and FilterOffsetB accordingly before performing the post loop DAB inter MB procedure as shown in .

For intra MBs the boundary strength BS is decided only based on the quantization step size qp because there are no such cases like skip MBs and CPB 0 blocks in the intra MBs. Moreover because intra MBs do not have inherited blockiness issues the DAB filtering operations should be only applied on pixels around the 8 8 block boundary as best seen in .

The post loop DAB intra MB procedure begins with block where the qp is determined. Block is followed by block where a determination is made whether qp is less than a threshold THD where THD is intra mb qp thd in . If the determination at block is Yes the BS is set to zero 0 at block . If the determination at block is No than the tile edges are determined at block . The block may be placed before block . Block is followed by block where a determination is made for each tile edge whether the tile edge is on the block boundary. If the determination at block is Yes for a tile edge the BS for that tile edge is set to 4 at block . The BS is set to zero 0 for those tile edges which are not located on the block boundary at block . Blocks and proceed to block where filtering takes place using in loop deblocking filter engine A using the calculated BS. The block ends the procedure . Block is shown proceeding to block for filtering for illustrative purposes.

With specific reference to an exemplary 8 8 block is shown. For illustrative purposes the current MB has tile edges V V H H. Note that Vis located on the block boundary between current block and the block to the left His located on the block boundary between current block and the block above Vis four samples away from Vin horizontal direction and His four samples away from Hin vertical direction.

The BS rule calculation for intra MBs is shown for the specific example in . Thus the values in Table 3 would change depending on the location of the tiles edges.

The inherited blockiness may become an issue for inter MBs. Thus the post loop DAB apparatus in general corrects the inherited blockiness by turning on the in loop deblocking filter engine A for the tile edges not located on block boundary. Specifically the BS of a tile edge is decided based on the following current qp current skipped MB current CBP neighbor s MB type and neighbor s qp. Two configurations are designed for the inter MB BS calculations. The two configurations include a simplified version and a complete version. The simplified version makes decisions based on the coding parameters of the current MB while the complete version considers more factors including neighbor s coding parameters in the BS calculation.

All pixels in a block may be modified if the BSs for all tile edges are greater than zero such as the last case in the last three lines in Table 4A. The effective filtering taps may be more than five because some pixels may be filtered twice. However the spatial activity checking conditions of Eq. 1 2 and 3 may prohibit some pixels from filtering. The filtering decision for each pixel is based on the BSs of the current and previous tiles and spatial activity checking is listed in Table 5 in which Vdenotes current tile edge Vdenotes previous tile edge x denotes no filtering w denotes weak filtering and s denotes strong filtering. The samples Q Q Qand Qhave different meanings for Vand V. When filtering V the samples Q Q Qand Qare equivalent to P P Pand Pin the . When filtering V the samples Q Q Qand Qare equivalent to P P Pand Pin the . The strongest filtering occurs when BS V 4 BS V 4 and all spatial activity checking conditions 1 2 and 3 hold true.

Returning again to because there is no texture coding for skipped MBs and CBP 0 blocks the skipped MBs and the blocks with CBP 0 inherit 100 of the artifacts from reference frames. To remove these artifacts a stronger filtering is needed. It is very different from the H.264 coding standard in which a weaker filter is used for the skipped MBs because the configuration of the in loop DB assumes that the blockiness in reference frames has been removed.

The stronger filtering is achieved by reducing all qp thresholds inter mb qp thd boundary0 inter mb qp thd inside0 inter mb qp thd boundary4 and inter mb qp thd inside4 by a constant and increasing the values of FilterOffsetA and FilterOffsetB. The reason to have higher FilterOffsetA and FilterOffsetB is to increase the chance to pass the spatial activity tests 1 2 and 3 and thus more samples would be filtered.

In implementation the qp is artificially increased by a constant qp jump for not coded block for skipped MBs and cbp0 blocks and pass the modified qp to the in loop deblocking filter engine A. This special treatment is applied to blocks with CBP 0 and skipped MBs. To simplify the procedure a MB is treated the same as a skipped MB if the number of luma CBP 0 blocks in that MB is more than the threshold num not coded blocks thd.

Block is followed by block where the filter setting for each pixel Q Q Qand Qis determined for Vand Vas shown in Table 5 above. Block is followed by block where the MB is filtered according to Table 5 for the example in .

In complete version the coding parameters of the neighboring MBs left and above affect the BS decision on the MB boundary. For those tile edges located inside of a MB the BSs are calculated the same as the simplified version. Let V denote a boundary between two MBs A and B BS V and BS V are the BSs determined by MB A and B based on the rules described in the simplified version then the new BS V is calculated according to equation Eq. 4 Max 4 

However in the complete version the skipped MBs and CBP0 blocks are processed the same as simplified version shown in and Tables 4A 4B and 5.

Although H.264 has an in loop DB artifact is still an issue when the content is coded at a low bit rate. It needs a post loop DAB apparatus to remove the artifacts introduced by coding. Although the H.264 in loop DB and the post loop DAB apparatus share the same core deblocking filter engine A the post loop DAB apparatus provides a stronger filtering. The stronger filtering is because a stronger BS may be assigned for an edge in the post loop DAB but it is impossible in the in loop DB . The BS in the in loop DB is determined by the rules specified in the H.264 standard. The maximum BS is two in the case where both blocks are Inter. Another reason stronger filtering can be accomplished is because a larger FilterOffsetA and FilterOffsetB may be assigned in the post loop DAB but the FilterOffsets used in in loop DB is read from the bitstream.

Returning again to block if the determination at block Yes meaning both blocks are Inter type then block is followed by block . At block a determination is made whether either block has a qp greater than or equal to inter mb qp thd4. If the determination at block is Yes then the BS is set to 4 at block . However if the determination at block is No then block is followed by block where a determination is made whether either block has a qp greater than or equal to inter mb qp thd2. If the determination at block is Yes then the BS is set to 2 at block . If the determination at block is No then the BS is set to 0 at block . Blocks and all continue to block of .

At block the FilterOffsetA is increased by a constant. Block is followed by block where the FilterOffsetB is increased by a constant. Block is followed by block where a determination is made whether a block has coded residuals. If the determination is No the procedure ends. However if the determination is Yes then block is followed by block . At block the qp is increased by a constant. Block also ends the procedure .

Increasing FilterOffsetA and FilterOffsetB increases the chance to pass the spatial activity tests in equations Eq. 1 2 and 3 and thus more samples would be filtered. Furthermore increasing qp by a constant decreases the parameters inter mb qp thd4 and inter mb qp thd2.

In experimental results a comparison of the second approach using a post loop deblocker with high MIPs denoted as SMCDB the disclosed DAB processes denoted as DAB and no DAB operations are shown in Table 7. The visual MOS score is listed in Table 7 in which the LCDB has compatible subjective score as SMCDB and both of them are much better than no DB.

In view of the above the post loop DAB apparatus uses the existing hardware of the in loop deblocking filter engine A as a core and carefully chooses the BS for each of the tile edges. To eliminate the annoying inherited blockiness the pixels in the inside of a block may be filtered which is achieved by setting a non zero BS for the tile edges in the middle of a block. In short the BS is determined by qp inter MB skipped MB and CBP.

To keep a low complexity configuration two versions have been described. The simplified version calculates BSs based on the coding parameters of current MB the MB to be filtered no information from neighboring MBs is required. However the complete version calculates the BSs based on the coding parameters of both current and neighboring MBs.

The low complexity configuration of the DAB apparatus in is also designed as a post deblocker to universally correct blockiness for a codec without an in loop DB such as MPEG4 and H.263P0 codecs. The procedures to calculate the boundary strength BS described in relation to the DAB apparatus is essentially the same for . Hence no further discussion is necessary. The DAB apparatus or removes blocking artifacts successfully with very small MIPs 2.5 MIPs for simplified version and 4 MIPs for complete version and memory requirements.

In one or more exemplary configurations the functions described may be implemented in hardware software firmware or any combination thereof. If implemented in software the functions may be stored on or transmitted over as one or more instructions or code on a computer readable medium. Computer readable media includes both computer storage media and communication media including any medium that facilitates transfer of a computer program from one place to another. A storage media may be any available media that can be accessed by a computer. By way of example and not limitation such computer readable media can comprise RAM ROM EEPROM CD ROM or other optical disk storage magnetic disk storage or other magnetic storage devices or any other medium that can be used to carry or store desired program code in the form of instructions or data structures and that can be accessed by a computer. Also any connection is properly termed a computer readable medium. For example if the software is transmitted from a website server or other remote source using a coaxial cable fiber optic cable twisted pair digital subscriber line DSL or wireless technologies such as infrared radio and microwave then the coaxial cable fiber optic cable twisted pair DSL or wireless technologies such as infrared radio and microwave are included in the definition of medium. Disk and disc as used herein includes compact disc CD laser disc optical disc digital versatile disc DVD floppy disk and blu ray disc where disks usually reproduce data magnetically while discs reproduce data optically with lasers. Combinations of the above should also be included within the scope of computer readable media.

The previous description of the disclosed configurations is provided to enable any person skilled in the art to make or use the disclosure. Various modifications to these configurations will be readily apparent to those skilled in the art and the generic principles defined herein may be applied to other configurations without departing from the spirit or scope of the disclosure. Thus the disclosure is not intended to be limited to the configurations shown herein but is to be accorded the widest scope consistent with the principles and novel features disclosed herein.

