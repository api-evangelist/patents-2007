---

title: Enabling secure remote assistance using a terminal services gateway
abstract: A secure remote assistance session between computers that are behind firewalls and/or NAT devices is provided by an arrangement that uses a terminal services (“TS”) gateway to enable utilization of a remote desktop protocol (“RDP”) connection by a terminal services client in a reverse direction to that used in a conventional terminal services session. The connection is made via a regular TS gateway protocol mechanism by which the TS client behind a firewall establishes a connection to the remote server that is typically behind a firewall that protects a corporate network. The server then functions as the terminal services client to tunnel RDP data through the established TS gateway connection through the NAT firewall to a client. Thus, the server and client reverse roles after the TS gateway connection is made to thereby enable remote viewing of the graphical user interface that is displayed by the client in support of the remote assistance session.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09438662&OS=09438662&RS=09438662
owner: MICROSOFT TECHNOLOGY LICENSING, LLC
number: 09438662
owner_city: Redmond
owner_country: US
publication_date: 20070430
---
Computer users particularly users without much technical expertise often have configuration problems or usage questions that are difficult for a support professional or even just a friend or family member to diagnose and fix over the phone. Remote assistance provided over a network or Internet connection is an effective way for users to get the help they need and makes it easier and less costly for corporate helpdesks to assist their users. After receiving a request for remote assistance the helper e.g. helpdesk expert can remotely connect to the problem computer view its desktop screens and temporarily take control of the computer by sending keyboard and mouse commands over the network connection.

Remote assistance has proven to be difficult to provide in the case where a remote user i.e. the helpee is behind a NAT network address translator firewall and the helper is inside a corporate network which is protected by an edge or perimeter type firewall. NAT firewalls are commonly used in small and or home networks to remap IP Internet Protocol addresses of computers in the small network to a single IP address that is typically provided by an Internet gateway using a cable or DSL digital subscriber line connection for example. The perimeter firewall is typically utilized to monitor traffic between the internal corporate network and a public network Internet by inspecting incoming traffic for malware i.e. malicious software such as viruses trojan horses rootkits spyware etc. . In addition remote assistance may be difficult to implement when the helpee is inside a corporate network behind a firewall and the helper is inside a different corporate network and also behind a firewall.

Current solutions to these problems include using an intermediary such as a node on the Internet where the helper and helpee meet to make a connection. While satisfactory in some situations the Internet node is insecure and typically requires the deployment of additional resources and often imposes scalability limitations due to the availability of such nodes. An alternative to the intermediary is for network administrators to open new incoming ports in the case of the perimeter firewall or map an incoming port to a specific computer in the network in the case of the NAT firewall . However network administrators are often hesitant to open or map ports since such actions are inherently insecure and can result in significant risks to the security of the network or enterprise which defeats the intended purpose of the firewalls.

This Background is provided to introduce a brief context for the Summary and Detailed Description that follow. This Background is not intended to be an aid in determining the scope of the claimed subject matter nor be viewed as limiting the claimed subject matter to implementations that solve any or all of the disadvantages or problems presented above.

A secure remote assistance session between computers that are behind firewalls and or NAT devices is provided by an arrangement that uses a terminal services TS gateway to enable utilization of a remote desktop protocol RDP connection by a terminal services client in a reverse direction to that used in a conventional terminal services session. The connection is made via a regular TS gateway protocol mechanism by which the TS client behind a firewall establishes a connection to the remote server that is typically behind a firewall which protects a corporate network. The server then functions as the terminal services client to tunnel RDP data using the established TS gateway connection through the NAT firewall to a client. Thus the server and client reverse roles after the TS gateway connection is made. In these reversed roles the server i.e. the original client sends control messages to the client. The server receives rendering data from the client i.e. the original server to thereby enable remote viewing of the graphical user interface that is displayed by the client in support of the remote assistance session.

In various illustrative examples a helpdesk behind a corporate network firewall provides remote assistance to a remote client e.g. a home user that is behind a NAT firewall that is used for Internet access. In one illustrative example the remote client accesses a web link provided by the TS gateway which when activated establishes an RPC HTTPS Remote Procedure Calls using Hypertext Transfer Protocol with SSL Secure Socket Layer connection between a plug in module exposed by the TS gateway and a COM type Common Object Model component such as ActiveX on the remote client. In another illustrative example a remote port from the client is forwarded to the TS gateway. In both illustrative examples the connection functions with the TS gateway just like a regular connection that is initiated by the remote client through the ActiveX component to a helpdesk server inside the corporate network that is running a terminal services client. The helpdesk server runs a remote assistance application to load a terminal services client to tunnel RDP display data through the NAT firewall using the established TS gateway connection to the remote client. This creates an end to end connection over which RDP data including graphical rendering data and commands may be streamed between the helpdesk and remote client during the remote assistance session.

This Summary is provided to introduce a selection of concepts in a simplified form that are further described below in the Detailed Description. This Summary is not intended to identify key features or essential features of the claimed subject matter nor is it intended to be used as an aid in determining the scope of the claimed subject matter.

The helper and helpee are typically in communication over a network which can be arranged as a local area network or arranged as a wide area network which may use portions of a public network such as the Internet. In environment helper and helpee communicate over network using a terminal services session which in this illustrative example uses a remote desktop protocol RDP that typically operates over a TCP IP Transmission Control Protocol Internet Protocol connection between the helper and helpee .

Remote assistance typically follows a procedure in which responsively to an assistance request from the helpee the helper initiates a connection using authentication data that is exchanged out of band. Once the helpee accepts the connection it utilizes a functionality in which the helper is enabled with an ability to view the screen i.e. the graphics that are normally displayed on a monitor or display device that is coupled to the helpee by virtue of rendering data that is streamed over RDP on network to the helper .

The helper may also temporarily take control of the helpee by which keyboard events and mouse events are sent as control messages over RDP from the helper to help the helpee . A helpdesk expert at helper may thus interact with the computer supporting the helpee as if the helpdesk expert were seated in front of the client helpee .

In the remote assistance environment shown in the graphical RDP rendering data flows from the remote client i.e. the helpee to the helpdesk server i.e. helper while the RDP controls message i.e. the keyboard and mouse events and flow from the server helper to the remote client helpee during a remote assistance session.

In a typical terminal services environment an application runs entirely on the terminal server . The remote client performs no local execution of application software. The server transmits the graphical user interface to the client. The client transmits the user s input back to the server. Accordingly as shown in the remote client generates keyboard events and mouse events that are redirected from the remote client to the terminal server over a network connection as indicated by reference numeral to the corporate network . The terminal server utilizes its own virtual keyboard and mouse driver to receive and interpret these keyboard and mouse events.

At the terminal server an RDP video driver renders display output by constructing rendering information into network packets using the RDP protocol and sending them over the network to the remote client . The display protocol is typically encrypted generally in a bi directional manner although in some cases only data from the remote client to the terminal server is encrypted. Such encryption is utilized to prevent discovery of user s passwords and other sensitive information by sniffing the wire.

At the remote client rendering data is interpreted into corresponding GDI API Graphics Device Interface Application Programming Interface calls to thereby show graphical screens and a user interface on a coupled display device or monitor. Thus as shown in RDP control messages flow from the remote client to the terminal server and RDP graphical rendering data flows from the terminal server to the client during a terminal services session. This is opposite to the data flow used in the remote assistance scenario as shown in and described in the accompanying text.

A terminal services client which is typically embodied as an executable file on the remote client uses the RPC HTTPS pipe to make an RDP connection to the terminal server to thereby establish a connection which supports a terminal services session.

As with the illustrative examples shown in the remote client in arrangement is located behind an NAT firewall and communicates to the helpdesk server in a corporate network through an external network .

Arrangement is described using a flowchart of an illustrative method that is shown in . The method starts at block . At block a user at the remote client determines that assistance is needed and requests help from a helpdesk that is located behind a corporate network firewall e.g. the firewall in . At block the helpdesk personnel determine that a remote assistance session would be desirable in order to resolve the remote user s problem.

At block the helpdesk personnel provide a special web link on the TS gateway . When the remote user clicks on the link as indicated by block a COM based component such as ActiveX component establishes an RPC HTTPS connection with a plug in module that is installed on the TS gateway . The ActiveX component is optionally downloadable by the remote client from the TS gateway or another source.

The plug in module is arranged for communicating to the Helpdesk server hosting the remote assistance application terminal services client . In one illustrative implementation this includes listening on a pre determined port called the remoted port on the TS gateway . A connection request to this port or to the remote application terminal services client in an alternative implementation invokes a notification from the plug in module to the ActiveX component to start establishing an RDP session and stream RDP data from the ActiveX component to the RA application TS client . As indicated at block this connection appears to the TS gateway as a regular TS gateway connection. In the case of the forwarded remote port the connection appears to the TS gateway as a remote port forwarded from the remote client i.e. TCP port number 3389 .

At block the helpdesk server runs a remote assistance process which loads a terminal services client and communicates with the TS gateway plug in module to thereby tunnel data through to the remote client s desktop. The established TS gateway connection between the plug in module and the ActiveX component is used to support the remote assistance session as indicated by block in . That is upon successful establishment of a terminal services session between the remote client and the helpdesk server using the TS gateway their usual respective roles are reversed for the remote assistance session. The remote client sends graphical RDP rendering data to the helpdesk server to enable the helpdesk expert to see the problem at the remote client . In addition RDP control messages i.e. keyboard and mouse events are sent from the helpdesk server to temporarily control the remote client during the remote assistance session. The illustrative method ends at block .

Although the subject matter has been described in language specific to structural features and or methodological acts it is to be understood that the subject matter defined in the appended claims is not necessarily limited to the specific features or acts described above. Rather the specific features and acts described above are disclosed as example forms of implementing the claims.

