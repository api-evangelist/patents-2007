---

title: Multi-channel echo compensation system
abstract: An echo compensation system may remove undesirable audio signals. The echo compensation system may utilize adaptive filters to remove echoes and undesirable signals received by a microphone. The echo compensation system may inhibit adaptation of an adaptive filter when left and right channel audio signals are highly correlated. In a two-channel system, inhibiting adaptation of one of two adaptive filters may reduce computational power requirements, while still removing undesirable signals. In a four-channel system, inhibiting adaptation of all but one of the four adaptive filters may reduce computational power requirements by a greater percentage.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08130969&OS=08130969&RS=08130969
owner: Nuance Communications, Inc.
number: 08130969
owner_city: Burlington
owner_country: US
publication_date: 20070416
---
This application claims the benefit of priority under 35 U.S.C. 119 to European Patent Application No. 06 008006.6 filed Apr. 18 2006 which is incorporated by reference.

This disclosure is directed to a multi channel echo compensation system. In particular this disclosure relates to a system to compensate for echoes generated by external audio sources.

Hands free telephone systems are used in vehicles. Such systems may include one or more receivers that acquire speech signals. Loudspeakers may also be mounted in the vehicle. A loudspeaker may deliver audio signals from various audio sources. The receivers may acquire the audio signals transmitted by the loudspeakers. Due to speaker placement and the configuration of a vehicle interior the receiver may acquire echoes. Such signals may distort the microphone signals.

Existing hands free systems for echo compensation may not adequately address echo signals originating from loudspeakers. Such systems may introduce artifacts into the signal path. Therefore a need exists for an echo compensation system that reduces echo signals originating from loudspeakers in a vehicle.

An echo compensation system may remove undesirable audio signals. The echo compensation system may utilize adaptive filters to remove echoes and undesirable signals received by a microphone. The echo compensation system may inhibit adaptation of an adaptive filter when left and right channel audio signals are highly correlated. In a two channel system inhibiting adaptation of one of two adaptive filters may reduce computational power requirements while still removing undesirable signals. In a four channel system inhibiting adaptation of all but one of the four adaptive filters may reduce computational power requirements by a greater percentage.

Left and right channel adaptive filters may receive signals from a pre processor and generate a compensation signal. When the compensation signal is added to the microphone output signal the undesirable audio signals acquired by a microphone due to the loudspeakers may be removed or dampened.

The pre processor may determine a correlation value by generating a sum and difference signal corresponding to a left and right channel audio signal. The left and right channel audio signals may be highly correlated if a difference signal is below a predetermined value. When the pre processor determines that the left and right channel audio signals are highly correlated the pre processor may inhibit adaptation of all but one of the adaptive filters. This may reduce the computation load while providing adequate echo compensation.

Other systems methods features and advantages will be or will become apparent to one with skill in the art upon examination of the following figures and detailed description. It is intended that all such additional systems methods features and advantages be included within this description be within the scope of the invention and be protected by the following claims.

Some audio systems in vehicles may use beam forming circuits to communicate with multiple microphones to combine the microphone output signals. Such audio systems may use adaptive filters to compensate for unwanted signals contained in the microphone signal. Such adaptive filters may use the input signals from the audio source to determine a compensation signal.

In some systems the adaptive filters may model the undesirable signals captured by the microphone. The adaptive filters may receive the left channel and right channel output signals from the source device used to drive the loudspeakers. The adaptive filters may provide a compensation signal which may approximate the signal acquired by the microphones. The portion of the microphone signal contributed by the loudspeaker may be removed or dampened by subtracting the compensation signal from the microphone signal.

In a vehicle environment the square of the absolute value of the coherence value may vary greatly. Coherence may be shown by the formula 

Music signals may exhibit very low coherence. In contrast audio signals representing news or interviews may exhibit very high coherence such that the left and right channel signals may be linearly dependent. The coherence of such signals approximately equals one and the cost functions used in some multi channel adaptation processes may not have a unique solution. As a result the adaptive filter coefficients may need to be recalculated when a speaker change occurs. During this time undesirable echoes may be heard.

The audio signals transmitted by the loudspeakers and in the vehicle may be described through the following finite impulse response equations. The variable n indicates the time dependence of the coefficients. . . . and . . . .

A microphone pre processing circuit may process the signals acquired by the microphones . The microphone pre processing circuit may perform linear time invariant processing such as beam forming or high pass filtering. The output of the microphone pre processing circuit may be denoted as d n or the pre processed microphone output signal. A beam forming circuit may increase the signal to noise ratio of the microphone output signal d n and may provide directivity to a microphone array.

A left compensation channel of the dual channel pre processing circuit may receive the left channel input signal x n . A right compensation channel of the dual channel pre processing circuit may receive the right channel input signal x n . A left channel adaptive compensation filter may receive a left channel pre processor output signal x n . Similarly a right channel adaptive compensation filter may receive a right channel pre processor output signal x n .

The left and right channel adaptive compensation filters and may be implemented in hardware and or software and may include a digital signal processor DSP . The DSP may execute instructions that delay an input signal one or more additional times track frequency components of a signal filter a signal an or attenuate or boost an amplitude of a signal. Alternatively the left and right channel adaptive compensation filters and or DSP may be implemented as discrete logic or circuitry a mix of discrete logic and a processor or may be distributed over multiple processors or software programs.

A filter summing circuit may sum an output of the left and right channel adaptive compensation filters and to produce an estimated signal circumflex over d n . An output summing circuit may then sum the pre processed microphone output signal d n and the estimated signal circumflex over d n to provide the output or error signal e n . The estimated signal circumflex over d n may be subtracted from the pre processed microphone output signal d n as indicated by the minus sign. The estimated signal circumflex over d n may represent a compensation signal which when subtracted from the microphone output signal d n may remove or dampen unwanted signals received by the microphone .

The microphones may be part of a hands free telephone set. As such the microphones may acquire speech signals from a speaker. It may be desirable to reduce the audio signals produced by the loudspeakers and including the echo signals which may be apart of the microphone output signal d n . The left channel and right channel adaptive compensation filters and may be configured to reduce such undesirable components. The impulse response of the left channel and right channel adaptive compensation filters and may be defined by the following . . . . . . .

The left channel and right channel adaptive compensation filters and may be used to reduce the unwanted audio signals produced by the loudspeakers and . Considerable processing power may be conserved if adaptation of some of the adaptive compensation filters and can be delayed during certain times. In that regard the multi channel echo compensation system may prevent adaptation of some of the adaptive compensation filters if the left and right channel input signals x n and x n are highly correlated. For example a monaural signal output by two loudspeakers may be highly correlated because a difference signal corresponding to the two loudspeaker channels may be small.

The correlation value may have different forms. For example the correlation value may be determined as a coherence value. A coherence threshold may be selected to be about 0.97. This means that the left and right channel input signals x n and x n may be very similar and the difference signal x n may be small. For highly correlated signals the summed signal may have a power level corresponding to about twice the input signal power x n or x n . A correlation circuit may calculate the degree of correlation between the left and right channel input signals x n and x n . The correlation circuit may be implemented as part of the pre processor or as part of the adaptation filters and or may be part of a separate processor or may be located remote from in the echo compensation system .

If the input signals x n and x n are highly correlated adaptation of all but one of the adaptive filters and may be deferred. This may represent a computational power savings of about 50 in a two channel system using two adaptive filters. Of course the multi channel echo compensation system may include more than two channels. For example the multi channel echo compensation system may include four or more channels and four or more adaptive filters in a multi channel configuration or in a surround sound implementation. A greater computational power savings of about 75 may be realized in a four channel system using four adaptive filters.

The order N of the left channel and right channel adaptive compensation filters and may be smaller than the order of the impulse responses. For example left channel and right channel adaptive compensation filters and may use 300 to 500 coefficients at a sampling rate of about 11 kHz. The left channel and right channel adaptive compensation filters and may provide a compensation signal to be subtracted from the microphone output signal d n . This may result in an output signal e n sometimes referred to as an error signal having the following form 

The error signal e n may be used to adapt the coefficients of the adaptive compensation filters and . The adaptation of the filters may be performed such that the estimated impulse response n and n may closely approximate the real impulse responses h n and h n .

Filter adaptation may be performed based on a least squares type of process. The filter adaptation may be based on other processes such as a normalized least mean squares process a recursive least squares process and a proportional least mean squares process. Further variations of the minimization algorithm may be used to ensure that the output of the filters does not diverge.

A left channel multiplier circuit may multiply an output of the left channel summing circuit by a common weighting factor equal to about 0.50. Similarly a right channel multiplier circuit may multiply an output of the right channel summing circuit by a common weighting factor equal to about 0.50. As a result the left and right channel pre processor output signals x n and x n may be the linear combinations of the left and right channel input signals x n and x n . The pre processor output signals x n and x n may represent a sum and difference signal respectively. The pre processor output signals x n and x n may be represented by the equations below where a common weighting factor may be realized by shifting an accumulator bit by one position.

In a two channel system for example the weighting factor may be equal to about 0.50. When more than two channels exist the weighting factor may be set equal to about the reciprocal of the number of channels. Accordingly in a four channel system the weighting factor may be equal to about 0.25.

As mentioned the summed signal or the output from the first summing circuit may have a power level that corresponds to about twice the signal power of the left or right channel input signals x n and x n for highly correlated signals. The output of the left channel summing circuit may be scaled by the common weighting factor of about 0.5 to normalize the signal amplitude.

Because the signal corresponding to the playback of news may be a monaural signal the right channel pre processor output signal x n the difference signal may approach a zero value during time period . When classical music is used as the input signal both the left channel pre processor output signal x n the summed signal and the difference signal x n may only differ slightly from the left and right channel input signals x n and x n during time period .

The echo compensation system may measure the power spectrum of the right channel pre processor output signal x n . When the measured power spectrum falls below a pre determined threshold the echo compensation system may inhibit adaptation of the right channel adaptive compensation filter .

For a two channel system the computing power required to adapt the compensations filters and may be approximately halved during the time that adaptation is inhibited. Note that adaptation of the right channel adaptive compensation filter may be inhibited if the correlation value between the left and right channel input signals x n and x n is above a predetermined threshold value. In other words when the difference signal x n is below a certain value.

A correlation value between the left and right channel input signals x n and x n may be performed by determining the squared norm of the signal power at the output of the pre processor . The correlation value may be determined using recursive methods to reduce computational costs. For example if the signal vectors have a length N the squared norm of the signal vector at time n equals the squared norm of the vector at time n 1 plus the nvalue squared of the signal vector minus the n N value squared of the signal vector. The correlation value may be determined according to the follow equations 1 1 .

For highly correlated input signals x n and x n the corresponding difference signal x n may be small. In particular the signal power may be determined as the norm of a corresponding signal vector. Thus a good indication of the correlation between the two signals may be obtained.

If the correlation value falls below a pre determined threshold corresponding release variable a n and a n may be set to zero according to the equations below 

The pre determined threshold for example may be set to about 0.03. Accordingly the determination of the output signal e n after subtraction of the compensation signal may be represented by the following 

In the equation above the summed terms which may correspond to a convolution may be determined if the corresponding release variables are non zero. Thus adaptation of the adaptive compensation filters may be performed under the conditions given by the following equations 

Note that adaptive filters of some echo compensation systems may exhibit convergence behavior according to the equations below when the input signals are not entirely correlated

However the multi channel echo compensation system may exhibit convergence according to the equations below even if the input signals are fully correlated. Accordingly the multi channel echo compensation system may avoid a non unique solution 

The left channel first summing circuit may sum an output of the left channel delay circuit and the left channel adaptive pre processing filter to produce a left channel error signal e n . The left channel error signal e n may be used to adapt the left channel adaptive pre processing filter . Note that an output of the left channel pre processor filter may be subtracted from an output of the left channel delay circuit as indicated by the minus sign. The left channel multiplier circuit may multiply an output of the left channel second summing circuit by a common weighting factor equal to about 0.5. The left channel multiplier circuit may provide the left channel pre processor output signal x n .

The right channel summing circuit may sum an output of the right channel delay circuit and the right channel adaptive pre processing filter to produce a right channel error signal e n . The right channel error signal e n may be used to adapt the right channel adaptive pre processing filter . Note that an output of the right channel pre processor filter may be subtracted from an output of the right channel delay circuit as indicated by the minus sign. The right channel multiplier circuit may multiply an output of the right channel summing circuit by a common weighting factor equal to about 0.5. The right channel multiplier circuit may provide the right channel pre processor output signal x n .

Use of the delay circuits and may ensure that the adaptive pre processing filters and both converge to optimal solutions. The delay attributed to the delay circuits and may be configured or programmed to be about one half of the length of the corresponding filters.

The dual channel pre processor may be used in an interview situation where one of the speakers is positioned closer or further from a microphone relative to the other speaker. The amplitude of the left or right channel may then be changed and or delays may be inserted. Additional filters that modify the tone may also be used.

Two speakers may be located on different sides relative to a microphone during an interview. The amplitude of one speaker s voice may be greater on a first channel while the amplitude of the other speaker s voice may be greater on the second channel. In this circumstance the left and right channel input signals x n and x n may be considered to be highly correlated but their difference signal x S may not approach a zero value. The adaptive pre processing filters and and their associated delay circuits and may overcome this problem.

The left channel pre processor output signal x n and right channel pre processor output signal x n provided by the dual channel pre processor may be represented by the following equations 

Adaptation of the left and right channel adaptive pre processing filters and may be performed using a least squares type of process. Alternatively other processes may be used such as a normalized least mean squares process a recursive least squares process and a proportional least mean squares process. Further variations of the minimization process may be used to ensure that the output does not diverge.

Adaptation of the left and right channel adaptive pre processing filters and may be based on determination of the left and right channel error signals e n and e n . The left and right channel error signals e n and e n may be determined in accordance with the following equations 

Adaptation of the left and right channel adaptive pre processing filters and may be performed according to the equations below 

The adaptation of the left and right channel adaptive pre processing filters and may be performed at a slower rate than the adaptation of the adaptive compensation filters and of . A slower adaptation rate may be achieved for example by choosing smaller increments such that 0 

When the input signals are monaural signals meaning x n x n the left and right channel adaptive pre processing filters and may both converge to optimal solutions. The transfer functions may be represented by the following 

Based on the transfer functions the left and right channel pre processor output signals x n and x n may then have the form governed by the equations below. The below equations may be similar to the equations governing the dual channel pre processor of except for a delay of Ncycles 

The multi channel echo compensation system has been described for the case using two audio channels e.g. for a stereophonic system . However the multi channel echo compensation system may include more than two channels. If more than two channels are present the dual channel pre processor or may be configured to delay adaptation of all but one of the adaptive filters if a correlation value is greater than a predetermined threshold value for example at about a 97 correlation.

The logic circuitry and processing described above may be encoded in a computer readable medium such as a CDROM disk flash memory RAM or ROM an electromagnetic signal or other machine readable medium as instructions for execution by a processor. Alternatively or additionally the logic may be implemented as analog or digital logic using hardware such as one or more integrated circuits including amplifiers adders delays and filters or one or more processors executing amplification adding delaying and filtering instructions or in software in an application programming interface API or in a Dynamic Link Library DLL functions available in a shared memory or defined as local or remote procedure calls or as a combination of hardware and software.

The logic may be represented in e.g. stored on or in a computer readable medium machine readable medium propagated signal medium and or signal bearing medium. The media may comprise any device that contains stores communicates propagates or transports executable instructions for use by or in connection with an instruction executable system apparatus or device. The machine readable medium may selectively be but is not limited to an electronic magnetic optical electromagnetic or infrared signal or a semiconductor system apparatus device or propagation medium. A non exhaustive list of examples of a machine readable medium includes a magnetic or optical disk a volatile memory such as a Random Access Memory RAM a Read Only Memory ROM an Erasable Programmable Read Only Memory i.e. EPROM or Flash memory or an optical fiber. A machine readable medium may also include a tangible medium upon which executable instructions are printed as the logic may be electronically stored as an image or in another format e.g. through an optical scan then compiled and or interpreted or otherwise processed. The processed medium may then be stored in a computer and or machine memory.

The systems may include additional or different logic and may be implemented in many different ways. A controller may be implemented as a microprocessor microcontroller application specific integrated circuit ASIC discrete logic or a combination of other types of circuits or logic. Similarly memories may be DRAM SRAM Flash or other types of memory. Parameters e.g. conditions and thresholds and other data structures may be separately stored and managed may be incorporated into a single memory or database or may be logically and physically organized in many different ways. Programs and instruction sets may be parts of a single program separate programs or distributed across several memories and processors. The systems may be included in a wide variety of electronic devices including a cellular phone a headset a hands free set a speakerphone communication interface or an infotainment system.

While various embodiments of the invention have been described it will be apparent to those of ordinary skill in the art that many more embodiments and implementations are possible within the scope of the invention. Accordingly the invention is not to be restricted except in light of the attached claims and their equivalents.

