---

title: Systems and methods for distance-proof N-pass auto negotiation for gigabit ethernet
abstract: The present invention provides distance-proof N-pass Auto Negotiation systems and methods for Gigabit Ethernet. The present invention distance proofs Auto Negotiation. No matter the distance between two nodes configured according to the systems and methods of the present invention, the link at either end of the two nodes will only come up once each end has negotiated, resolved its link partner's capabilities, and received a similar success signal from the remote node.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08184556&OS=08184556&RS=08184556
owner: Ciena Corporation
number: 08184556
owner_city: Linthicum
owner_country: US
publication_date: 20071119
---
The present invention relates generally to Ethernet and more particularly to systems and methods for distance proof N pass Auto Negotiation mechanisms which enable Auto Negotiation between Ethernet devices despite delay due to extended distances over an optical network.

The IEEE 802.3 2005 standard which is incorporated in full by reference herein specifies Ethernet local area network LAN operation for selected speeds of operation from 1 Mb s to 10 Gb s using a common media access control MAC specification management information base MIB and capability for Link Aggregation of multiple physical links into a single logical link. Gigabit Ethernet GbE is one particular implementation defined in the IEEE 802.3 2005. GbE is commonly referred to as 1000BASE X where X refers to either CX SX LX or non standard ZX

In IEEE 802.3 2005 clause 37 Auto Negotiation for 1000BASE X allows a device local device to advertise modes of operation it possesses to a device at the remote end of a link segment link partner and to detect corresponding operational modes that the link partner may be advertising. The Auto Negotiation function exchanges information between two devices that share a link segment and automatically configures both devices to take maximum advantage of their abilities. The Auto Negotiation function allows the devices at both ends of a link segment to advertise abilities acknowledge receipt and understanding of the common mode s of operation that both devices share and to reject the use of operational modes that are not shared by both devices.

Optical transmission systems can be used to provide extended reach between Ethernet clients such as GbE. For example these systems can include SONET SDH network elements Optical Transport Network OTN network elements dense wave division multiplexing DWDM coarse wave division multiplexing CWDM and the like with optical amplifiers and repeaters to provide extended reach. Additionally these systems can also support IEEE 802.3 2005 specifications providing layer two support functionality for Ethernet clients. For example conventional SONET SDH OTN and DWDM CWDM transponder systems currently support layer two interfaces such as GbE and can include Auto Negotiation functionality.

Referring to a network diagram illustrates an example of Auto Negotiation in steps between clients connected through wavelength division multiplexed WDM devices over an optical network . The clients can include switches routers or the like with GbE interfaces to the WDM devices . The WDM devices include line cards capable of receiving GbE interfaces and providing Ethernet capabilities such as Auto Negotiation. Additionally the WDM devices can include optical amplifiers optical filters and the like as are known in the art with regards to optical transmission systems. The optical network represents intervening nodes not shown at geographically diverse locations. For example the optical network can span 8000 km in an exemplary embodiment.

At step which is at a time t the link between the client and the WDM device is back up and running. Here Auto Negotiation begins between the client and the WDM device and the WDM device sends an Auto Negotiation start message to the WDM device through the optical network . At step which is at time t 30 ms the Auto Negotiation is complete between the client and the WDM device and the link is up with the secondary backup link back in a passive state. Also the Auto Negotiation start message is received by the WDM device through the optical network and the WDM device begins Auto Negotiation with the client . Note in this example the Auto Negotiation state machines between the WDM devices are spaced apart by a delta time. This delta time represents the transit time through the optical network . For example on the optical network with a link length of 8000 km the delta time would be approximately 30 ms. This delta time is a function of the latency associated with the optical network .

Each of the clients and the WDM devices are configured to operate Auto Negotiation state machines. For example IEEE 802.3 2005 defines the Auto Negotiation state machine in . The state machine operated at the client is ahead of the state machine at the WDM device because of the distance and associated latency on the optical network . Accordingly the state machine at the client determines success between the client and the WDM device and the link is up at step . This causes the client to stop transmitting on the secondary backup link as it reverts to the primary link between the client and the WDM device . Finally at step the WDM device receives the Auto Negotiation start message and Auto Negotiation starts between the WDM device and the client .

At step which is at a time t 30 ms 30 ms it is determined that there is an Auto Negotiation error between the client and the WDM device . For example the link between client and WDM device could be set for half duplex while the other links are full duplex. Accordingly the link between the client and the WDM device is not up and the secondary backup link is also not up. Here WDM device sends a link error message to WDM device based on the Auto Negotiation error. At step which is at a time t 30 ms 30 ms 30 ms the WDM device receives the link error message and sends this to the client which accordingly begins transmitting on the secondary backup link again. Effectively this process results in a link flagging at client between the primary and secondary link which results in a traffic hit of at least 60 ms.

The Auto Negotiation specification includes a LINK TIMER which is defined as 10 ms with a tolerance of 10 ms. This is the only timer defined in clause 37 of IEEE 802.3 and it is used throughout the Auto Negotiation process to verify that both link partners have enough time to complete. The tolerance is implementation specific and may not be the same across different system implementations. Generally a single pass through Auto Negotiation i.e. a run of the Auto Negotiation state machine takes approximately 30 ms due to the number of instances LINK TIMER is operated in the state machine.

Thus the conventional Auto Negotiation mechanisms can fail when any two client devices are space apart by a delta time such that the route transit time results in one state machine finishing before the other signals a success or failure indication. Any failure to successfully negotiate will only be reported at another client after a minimum of 2 delta time. Disadvantageously these current mechanisms prevent Auto Negotiation over extended distances as are common with regard to Ethernet clients over optical networks.

In various exemplary embodiments the present invention provides distance proof N pass Auto Negotiation systems and methods for Gigabit Ethernet and the like. The present invention distance proofs Auto Negotiation. No matter the distance between two nodes configured according to the systems and methods of the present invention the link at either end of the two nodes will only come up once each end has negotiated resolved its link partner s capabilities and received a similar success signal from the remote node. Advantageously the present invention provides an exemplary embodiment which maintains compliance to the IEEE 802.3 2005 standards.

In an exemplary embodiment of the present invention a method for distance proof Auto Negotiation includes determining a delay between a first and second node wherein the first and second nodes include an Ethernet link configured to Auto Negotiate and implementing delay mechanisms at the first and second nodes in Auto Negotiation responsive to the determined delay. In one exemplary embodiment the delay mechanisms include setting a variable n which is the number of Auto Negotiation restarts responsive to the determined delay restarting Auto Negotiation up to n times responsive to successful priority resolution and if Auto Negotiation is restarted n times without receiving an indication declaring link down at the end of the nth time Auto Negotiation is run. The variable n is one of manually set through a management system connected to the first and second nodes and automatically set by the first and second nodes.

Optionally the determined delay is measured through a latency measurement algorithm between the first and second nodes and the latency measurement algorithm includes an exchange of timestamped messaged between the first and second nodes to determine delay. The variable n can be determined based on a constant value of two representing one restart for each state machine at the first and second node plus an average round trip delay between the first and second nodes divided by a time for running Auto Negotiation. In another exemplary embodiment the delay mechanisms include waiting at IDLE DETECT during Auto Negotiation at the first node until reception of an indication from the second node. The waiting at IDLE DETECT can be up to a predetermined time period. Optionally the first and second nodes include optical network elements and the delay is responsive to latency associated with an extended distance between the first and second nodes.

In another exemplary embodiment of the present invention a method for distance proof n pass Auto Negotiation includes determining a delay between a first and second node wherein the first and second nodes include an Ethernet link configured to Auto Negotiate setting a variable n which is the number of Auto Negotiation restarts responsive to the determined delay receiving an Auto Negotiation start at the first node starting an Auto Negotiation state machine at the first node during an IDLE DETECT state restarting Auto Negotiation at both the first and second node up to n times responsive to successful priority resolution and if Auto Negotiation is restarted n times without receiving an indication from the second node declaring link down at the end of the nth time Auto Negotiation is run. The variable n can be one of manually set through a management system connected to the first and second nodes and automatically set by the first and second nodes.

Optionally the determined delay is measured through a latency measurement algorithm between the first and second nodes and the latency measurement algorithm includes an exchange of timestamped messaged between the first and second nodes to determine delay. Alternatively the variable n is determined based on a constant value of two representing one restart for each state machine at the first and second node plus an average round trip delay between the first and second nodes divided by a time for running Auto Negotiation. Optionally the first and second nodes include optical network elements and the delay is responsive to latency associated with an extended distance between the first and second nodes. Alternatively the method for distance proof n pass Auto Negotiation is compliant to IEEE 802.3 standards for 1000BASE X Auto Negotiation.

In yet another exemplary embodiment of the present invention a network configured for distance proof Auto Negotiation includes a first optical network element connected to a first Ethernet client device and a second optical network element connected to a second Ethernet client device wherein the second optical network element is interconnected to the first optical network element through an optical network and wherein the optical network causes delay between the first optical network element and the second optical network element wherein each of the first optical network element the second optical network element the first Ethernet client device and the second Ethernet client device is configured to perform Auto Negotiation and wherein the first optical network element and the second optical network element are configured to provide distance proof Auto Negotiation including implementing delay mechanisms in Auto Negotiation responsive to the delay between the first optical network element and the second optical network element.

Optionally the delay mechanisms include determining the delay between the first optical network element and the second optical network element setting a variable n which is the number of Auto Negotiation restarts responsive to the determined delay restarting Auto Negotiation up to n times responsive to successful priority resolution and if Auto Negotiation is restarted n times without receiving an indication declaring link down at the end of the nth time Auto Negotiation is run at the first optical network element. The variable n can be one of manually set through a management system connected to the first and second optical network elements and automatically set by the first and second optical network elements.

Alternatively the determined delay is measured through a latency measurement algorithm between the first and second optical network elements and the latency measurement algorithm includes an exchange of timestamped messaged between the first and second optical network elements to determine delay. The variable n can be determined based on a constant value of two representing one restart for each state machine at the first and second node plus an average round trip delay between the first and second nodes divided by a time for running Auto Negotiation. Optionally the first and second Ethernet client devices include storage area network devices.

In various exemplary embodiments the present invention provides distance proof N pass Auto Negotiation systems and methods for Gigabit Ethernet and the like. The present invention distance proofs Auto Negotiation. No matter the distance between two nodes configured according to the systems and methods of the present invention the link at either end of the two nodes will only come up once each end has negotiated resolved its link partner s capabilities and received a similar success signal from the remote node.

Referring to an Auto Negotiation state diagram which is distance proof is illustrated according to an exemplary embodiment of the present invention. The Auto Negotiation state diagram is started at power on at link reset at link fail at link enable and the like step . The first state is AN ENABLE which is the starting point for Auto Negotiation. Here the device entering Auto Negotiation transmits a breaklink. The state diagram exits to AN RESTART if Auto Negotiation is enabled and to AN DISABLE LINK OK if Auto Negotiation is disabled. The AN RESTART state ensures that the link partner sees that the device is restarting Auto Negotiation. The state diagram exits from AN RESTART after a LINK TIMER duration 10 ms up to 10 ms tolerance .

After AN RESTART the state diagram enters ABILITY DETECT . This state ensures the device is receiving proper abilities from the link partner and the device transmits its own abilities to the link partner. The ABILITY DETECT state exits after the device has received three consecutive config regs that are not breaklink. Next the state diagram enters ACKNOWLEDGE DETECT which ensures that the link partner has acknowledged that it has seen the device s abilities. Also the device transmits an acknowledgment to the link partner. The ACKNOWLEDGE DETECT state exits back to start if the device receives three consecutive config regs with breaklink or if the received abilities in ACKNOWLEDGE DETECT are different than the abilities received in ABILITY DETECT . The ACKNOWLEDGE DETECT exits to COMPLETE ACKNOWLEDGE if the abilities match between the A ACKNOWLEDGE DETECT and ABILITY DETECT states.

The COMPLETE ACKNOWLEDGE state ensures that the link partner has time to see that the device has sent an acknowledgment. The COMPLETE ACKNOWLEDGE state exits to the start if the device receives three consecutive config regs with breaklink. The COMPLETE ACKNOWLEDGE state exits to IDLE DETECT after the LINK TIMER is done and if one of the devices does not support next page exchange or if both devices are done transmitting next pages and the device is not receiving breaklink. The COMPLETE ACKNOWLEDGE state exits to NEXT PAGE WAIT is both devices support next page exchange and at least one device still has next pages to transmit.

The IDLE DETECT state ensures the link partner is ready to establish a link before the device relinquishes control to the Physical Coding Sublayer PCS . The IDLE DETECT state returns to start if the device receives three consecutive config regs with breaklink. The IDLE DETECT states exits to LINK OK if the device receives three consecutive idle codes and the LINK TIMER is done. In the LINK OK state Auto Negotiation is complete and the PCS now has control.

The present invention provides mechanisms to allow the Auto Negotiation state diagram to operate despite latency between devices such as due to extended distances over optical networks over satellite networks or the like. In one exemplary embodiment of the present invention n pass steps are taken in the IDLE DETECT state to provide a distance proof implementation of the state diagram . In another exemplary embodiment of the present invention the state diagram can remain in the IDLE DETECT state until success is determined from the other end. Here the state diagram proceeds to the LINK OK state only after receiving acknowledgment from the other end. Note this embodiment is not standards compliant.

Referring to a flowchart illustrates the n pass steps for distance proofing the Auto Negotiation state diagram according to an exemplary embodiment of the present invention. The n pass step is entered once the state diagram is in the IDLE DETECT state. In the IDLE DETECT state the priority resolution function is run step . The present invention utilizes an n pass architecture where the state diagram is restarted up to n times i.e. n pass where n is a function of the latency between clients.

The n pass step is configured to run n times while at the IDLE DETECT state while the node is successfully resolving the capabilities in order to provide the other end time to provide a success or failure indication of Auto Negotiation. If the device does not receive a success or failure indication within n passes then the link is declared down and breaklinks are sent. Conversely if the other end sends a success or failure indication the n pass steps are stopped and the state diagram proceeds to LINK OK .

If the node successfully resolves the capabilities step then it is checked to see if a success indication has been received from the other end step . If so the link is up and the state diagram proceeds to the LINK OK state. If not then an n pass counter is checked step to see if the node has restarted the state diagram n times yet. If not then the node restarts the Auto Negotiation state diagram by going back to the start step . If the node has already restarted n times step then the state diagram declares the link down and proceeds to the start step . In the node does not successfully resolve the capabilities step then the state diagram declares the link down and proceeds to the start step . Declaring the link down includes sending breaklinks to the other end and to an attached client. Additionally the n steps can declare the link down upon receiving a failure indication from the other end as well.

The LINK TIMER at most provides up to 20 ms of tolerance 10 ms 10 ms of tolerance . Now even if all the standard driven Auto Negotiation implementations have this tolerance build in then the max link timer value can be 20 ms. The priority resolution function runs in the IDLE DETECT state. Assume that the priority resolution function runs as soon as the state diagram enters the IDLE DETECT state and starts the link timer there is only 20 ms round trip time to send an Auto Negotiate restart message to the end node and to receive the response. Now even if the auto negotiation state machine at the other end completes in 1 ms there is only 19 ms for the transmission delay. Now assuming the packet travels at the speed of light then that maximum distance that this could cater to is 7600 km round trip. Hence the maximum distance that is possible between B and C is 3800 km. Note these are all best case assumptions and likely would be significantly lower given extra latency on the optical network such as due to equipment delays and slower state machine operation.

Advantageously this implementation is completely standards compliant and distance proof upon selecting n appropriately as described herein. These mechanisms can be implemented on layer two compliant optical network elements which interconnected over an IEEE 802.3 2005 compliant link over extended distances. Accordingly clients attached to the optical network elements can successfully auto negotiate despite extended distances and associated latency.

Referring to a flowchart illustrates an IDLE DETECT wait implementation for distance proof Auto Negotiation according to another exemplary embodiment of the present invention. Here Auto Negotiation starts such as the Auto Negotiation state diagram in step . In the IDLE DETECT state the implementation waits for success or failure from the other end step . If the other end indicates success step then the implementation declares the link up e.g. moves to the LINK OK state step . If the other end indicates failure step then the implementation declares the link down e.g. sends breaklink to the other end and an attached client step . Alternatively the implementation could include a pre determined timer set to wait to avoid indefinitely waiting in the IDLE DETECT state. Note this implementation is outside of the IEEE 802.3 2005 standard.

Referring to a network configured with distance proof n pass Auto negotiation is illustrated according to an exemplary embodiment of the present invention. The network includes a first WDM network element NE connected to a second WDM NE through an optical network . The WDM NEs each include layer two capable line modules connected to clients . In this embodiment the WDM NEs are configured to operate the n pass implementation as described in . Note the clients do not need to implement these mechanisms since the latency between the clients and associated NEs is likely significantly less than 20 ms requiring only a single pass using standard Auto Negotiation mechanisms.

Those of ordinary skill in the art will recognize that the WDM NEs could also be SONET SDH devices Optical Cross Connects OXC Ethernet switches routers or the like. These devices can all be configured for extended reach over the optical network . The distance proof mechanisms for Auto Negotiation can be included on any layer two capable line card in any of these systems allowing for extended reaches while providing standards compliant 1000BASE X Auto Negotiation.

The optical network includes optical amplifiers wavelength division multiplexers optical add drop multiplexers and the like. Effectively the optical network is configured to provide a wavelength carrying the layer two traffic from the client to the client over an extended distance L km. In an exemplary embodiment the number n passes through the n pass implementation can be defined according to the formula 

The number of passes can be manually or automatically provisioned in the WDM NEs . For example a network management system NMS can be connected to the WDM NE through a data network . A user could manually set the number of passes through the NMS directly to the NE . For example the NMS could include a user interface setting the link distance and automatically calculate n based on the formula provided herein. Also the user could access the NE through a data communication link over an optical service channel or the like to provision n on the NE . The NMS can also include an element management system EMS craft interface CI or the like as is known in the art.

The NEs can be configured to implement a latency measurement protocol to automatically determine the delay associated with the optical network . For example NE can send a message to NE such as over the optical service channel. Before sending the message NE can include a hardware timestamp in the message. This is a request packet. On receiving the request packet NE can generate a response packet. NE copies the timestamp value back from the received request packet to the response message and sends it to the NE . The NE on receiving the response packet retrieves the timestamp value from the response packet. NE then takes a fresh hardware timestamp. It then sees the difference between these timestamp and calculates the round trip time.

Accordingly this value can be used in conjunction with the formula to automatically set n. This procedure can also be utilized in the other direction from NE to NE . Note there could be different n settings at the NEs . For example there could be diverse paths of differing lengths L through the optical network . Alternatively the NEs can include other mechanisms for determining latency as are known in the art.

Referring to an exemplary implementation of a distance proof Auto Negotiation is illustrated between clients according to an exemplary embodiment of the present invention. In The client is connected to an NE which is connected to an NE through an optical network . The client is connected to the NE . The clients can include Ethernet switches routers or the like. The NEs can include WDM NEs SONET SDH NEs OTN NEs and the like. In this example the NEs are each configured to operate the n pass Auto Negotiation of the present invention and the latency between the NEs is 15 ms or a round trip time of 30 ms.

In at step a link between the client and the NE is down forcing the links between the NEs and between the NE and client down. Accordingly a backup link becomes active between the clients . The backup link can be on a diverse path through the optical network or on the same path with different modules in the event of a module failure. At step time t the link is back up and Auto Negotiation starts between the client and the NE and the NE sends an Auto Negotiation start request to the NE over the optical network.

At step time t 15 ms the Auto Negotiation start request is received by the NE and Auto Negotiation is still in progress between the client and the NE . Upon receipt of the Auto Negotiation start request Auto Negotiation begins between the NE and the client . At step time t 15 ms 15 ms Auto Negotiation between the NEs resolves successfully Auto Negotiation is still in progress between the NE and the client and Auto Negotiation has restarted based on the mechanisms of the present invention between the NE and the client .

In at step time t 15 ms 30 ms Auto Negotiation is successful between the NE and the client i.e. 30 ms is the time for the state machine to run following receiving the restart request in step . Accordingly resolution is successful and the NE restarts Auto Negotiation for the first pass. The NE sends a success indication to the NE and Auto Negotiation is in progress for the second pass between the NE and the client . At step time t 15 ms 30 ms 15 ms the success indication message is received at the NE . Also the second pass is now complete between the NE and the client so there is a possibility that the remote link status may be received at or after this complete i.e. with timer expiry in IDLE DETECT between the NE and the client and this link is declared down. Accordingly the NE and the client utilize an extra pass to give ample time for the remote link status packet to be received.

At step time t 15 ms 30 ms 15 ms 15 ms Auto Negotiation for the third pass is in progress between the NE and the client and the success message has been received from the NE . Auto Negotiation is successful between the NE and the client . At step time t 15 ms 30 ms 15 ms 30 ms Auto Negotiation for the third pass completes between the NE and the client and the success message has been received from the NE . Accordingly the Auto Negotiation state machine exits IDLE DETECT to LINK OK and the link is brought up between the NE and the client between the NEs and between the NE and the client and the backup link is taken down. Hence Auto Negotiation is successful despite a 30 ms delay round trip between the NEs .

Additionally other mechanisms could be used to extend Auto Negotiation time. For example the LINK TIMER could be manually extended for the NEs over an extended distance. However this implementation and the implantation described in would not be standards compliant but they would provide a distance proof Auto Negotiation solution.

The various exemplary embodiments described herein can be utilized to make Auto Negotiation mechanisms distance proof. In one particular example this could be used in Storage Area Network SAN applications. Internet Protocol IP based SAN is emerging as one of the fastest growing SAN technologies. These utilize Ethernet at layer two. Accordingly the present invention could be utilized to provide distance extension to IP SAN s with virtually no distance limitation with regard to Auto Negotiation.

The mechanisms described herein reference GbE as an exemplary implementation. Those of ordinary skill in the art will recognize that the present invention can equally apply to other types of extended reach Ethernet implementations such as 10 GbE 100 GbE and the like. Also these mechanisms can be enabled or disable in a device.

Although the present invention has been illustrated and described herein with reference to preferred embodiments and specific examples thereof it will be readily apparent to those of ordinary skill in the art that other embodiments and examples may perform similar functions and or achieve like results. All such equivalent embodiments and examples are within the spirit and scope of the present invention and are intended to be covered by the following claims.

