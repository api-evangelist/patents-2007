---

title: Method of storing and accessing header data from memory
abstract: Methods of storing and accessing data using a header portion of a file are disclosed. In an embodiment, a method of storing content in a non-volatile memory is disclosed. The method includes reading a content file including media content and including a trailer, storing information related to the trailer together with secure data in a header portion of a file, and storing the file to a storage element of the non-volatile memory or a memory area of a host device coupled to the non-volatile memory device.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08069298&OS=08069298&RS=08069298
owner: SanDisk Technologies Inc.
number: 08069298
owner_city: Plano
owner_country: US
publication_date: 20070629
---
This application is related to an application being filed concurrently herewith by Chang et al. entitled Media Content Processing System and Non Volatile Memory that Utilizes a Header Portion of a File Ser. No. 11 771 775 which application is incorporated herein by reference in its entirety.

The present disclosure is generally related to non volatile memory systems that include access to a header portion and a content portion of a file. Memory systems such as memory cards that include non volatile memory devices have many purposes and can be used to store media content such as audio or video files. In such systems information related to the media content such as a title of a song or a movie may be stored in a last sector of the memory. A host device of the memory system such as a mobile phone or a host computer may need to retrieve the last sector of a file for multiple data files and a file system at the host device may be required to traverse a memory cluster to find the last sector data associated with one or more of the multiple data files. This task may consume a considerable amount of valuable processing resources and take a large amount of time reducing performance of the device. For example a processor may be requested to traverse through a file access table FAT that has thousands of files during an initialization process leading to a prolonged initialization period which creates the perception of degraded performance. In addition with media files customers may wish to find music information for display. Conventional systems can take a long time to read the designated sector and check the frame before the media file starts to play. This problem can be more severe with certain processors and for memory that contains a large number of encrypted files. Hence there is a need for improved control of stored media content.

Methods of storing and accessing data using a header portion of a file are disclosed. In an embodiment a method of storing content in a non volatile memory is disclosed. The method includes reading a content file including media content and including a trailer storing information related to the trailer together with secure data in a header portion of a file and storing the file to a storage element of the non volatile memory or a memory area of a host device coupled to the non volatile memory device. The information may include a trailer location.

In another embodiment a method of retrieving content is disclosed. The method includes reading content from a non volatile memory reading trailer data information associated with the content from a header portion of a secure file and providing data related to the trailer data to a display device of a host device having access to the non volatile memory. The header portion further includes secure data items related to the content.

In another embodiment a method of accessing media content using a non volatile rewritable memory is disclosed. The method includes receiving information regarding access rights storing the access rights in a secure memory area of the non volatile rewritable memory supplying a decrypted version of at least one selected encrypted media content item and supplying metadata retrieved from a header portion of the secure memory area. The metadata is associated with the at least one selected encrypted media content item. The decrypted version of the at least one selected encrypted media content item is to be provided to a host device. The access rights permit access to content decryption keys for decrypting encrypted media content stored in the non volatile rewritable memory.

The host device may communicate with a service provider via a network . The service provider can be a media content source. The host device may also communicate display data to a display device which may be coupled to the host device or integrated with the host device .

The host device includes the memory device a processor that has access to the memory device a display interface and a network interface that is responsive to the network . The display interface may receive data from the processor and communicate the data to the display device for display. The memory device includes a storage media and a controller that controls access to data stored at the storage media . The storage media includes a secure memory area and a public memory area . The secure memory area includes encryption key identifiers IDs one or more control structures and optionally an encryption key table .

The public memory area may also include a secure file that includes a header portion having metadata and trailer data and that includes a content portion . The header portion includes security data trailer data and metadata related to content to be stored in the public memory area . The security data can include directory information related to a hidden area within the secure memory area of the storage media . The trailer data may include a location associated with a predetermined portion of the file content. For example the trailer data may include a location associated with a limited portion of the content such as the last 512 bytes of a file a selected sector of data from the file a predefined segment of the file or any combination thereof. In a particular illustrative embodiment the trailer data includes a first field to indicate whether the trailer data is aligned to a sector boundary a second field to identify a number of sectors of the trailer data a third field to identify a sector offset value of the trailer data and a fourth field to identify a byte offset value associated with a sector of a memory area such as the secure memory area and the public memory area of the memory device . The header portion includes at least one secure data item and includes metadata related to media content to be stored in a non volatile memory such as the memory device . The header portion can include a variable number of fields that include data related to the content file. At least one of the fields contains a signature area.

The host device includes software drivers that can be executed by the processor to communicate with various components of the host device such as the display interface network interface adapters such as the network interface adapter modems other internal and peripheral hardware or any combination thereof. Additionally the host device includes software applications and application program interfaces APIs that can be executed by the processor to provide functionality to the host device . The APIs may include one or more instructions executable by the processor to store a last sector location e.g. trailer data of a file to be stored in the memory device into a header portion of the file. The APIs may also include at least one instruction to read a last sector of the file.

The host device also includes a system agent file system toolkit . The system agent file system toolkit includes a system agent software application that may be executed by the processor or by the controller to configure various aspects of the storage media . The system agent file system toolkit may be used to access content stored on the storage media based on a set of credentials associated with the system agent file system toolkit . In a particular embodiment the system agent file system toolkit may have a built in set of credentials that can be authenticated by the controller using an access control record stored in a hidden partition of the storage media .

Additionally the host device includes read write applications executable by the processor and or the controller to access the secure memory area and the public memory area . The memory device may also include a hidden partition . The hidden partition may not be visible to a file system of the host device but may be accessible to the controller of the memory device . The hidden partition may include one or more Access Control Records ACRs . Each record may include a table of authentication credentials and associated permissions. The controller may utilize the ACR within the hidden partition to control access to content stored in the public memory area and to the secure memory area by authenticating each access request and each host application. In a particular illustrative embodiment the host device may establish a secure session with the controller and the controller may decrypt content from the secure memory area and encrypt the content using a session key before providing the content to the host device . In this manner the content is protected and the encryption key can be used by the controller without exposing the encryption key outside of the memory device .

In general to access the hidden partition a login to an access control record ACR is provided. After login the controller can retrieve content. In a particular illustrative embodiment access permissions may be retrieved based on a login to provide unlimited playback of the retrieved content. In another particular illustrative embodiment the login may be calculated from a content identifier and secret values such as shared secret values between the host device and the memory device . The host device with the system agent file system toolkit can access the content because the toolkit application has the correct credentials built in.

In a particular illustrative embodiment the memory device includes a trusted content protection feature that may be used in conjunction with an application that is running on the host device . The application may include a digital rights management agent that can be part of the application. For example the application may be a media content player application such as an MP3 player application which may include the digital rights management DRM agent. Access to content stored on the memory device may be controlled by logging into an access control record which may be stored within the hidden partition of a storage media of the memory device . The access control record can include multiple trusted identifiers and associated credentials.

In a particular illustrative embodiment the hidden partition may include a set of access control records . For example each application running on the host device may have its own digital rights management agent and the hidden partition may include an access control record that is associated with each digital rights management DRM agent. In an alternative embodiment the hidden partition may include an access rights management table. The Access Control Records ACRs may be utilized to establish secure sessions between the memory device and an application running on the host device . The ACRs may also be used to determine access permissions to control access to stored content.

In a particular illustrative example the content portion of the file may include audio data such as a song and the metadata for that file may include data indicating song related information associated with the audio data such as a title a length of a particular audio track a name of a performer other information or any combination thereof. In a particular illustrative embodiment the song related information can include identity information such as Moving Picture Experts Group MPEG audio layer 3 MP3 identity information.

The secure memory area may receive and store control structures and other secure data such as encryption key identifiers IDs . The encryption key IDs may be accessed to locate encryption keys that may be used to encrypt or decrypt media content items.

In a particular illustrative embodiment the memory device may be provided by a manufacturer a service provider a reseller or another source. The memory device may include pre loaded media content such as audio content video content other media content or any combination thereof. The controller may utilize an ACR within the hidden partition to authenticate a host device and to determine access permissions for use with the host device . Once such access permissions are determined the software APIs and the read write application can be utilized by the controller to control access to such preloaded media content. For example the APIs may include a rights management protocol that may be used by the controller to lock the media content to the memory device . The APIs may allow the media content to be played on supported devices such as the host device . Further if the memory device is a removable memory device such as a flash card the memory device may be removed and connected to a different playback device which may be used to access and play the media content. By inserting metadata into a header portion of the content file the media playback device can readily access the title and song information for example to produce a playlist for selection by a user.

In a particular illustrative embodiment the host device may provide a file and a memory address from a file access table FAT to the storage device for secure storage. The FAT may be maintained and controlled by the host device . The host device may also provide an encryption key identifier ID to the storage device . The controller may execute one or more APIs and the read write application to extract metadata and location information related to trailer data from the content of the file and insert the extracted metadata and the location information into a header portion of the file. Alternatively the trailer data may be extracted from the content of the file and inserted into the header portion. Additionally the controller may write security data from the header portion of the secure file to the secure memory area . The controller may also access the encryption key table to retrieve an encryption key associated with the encryption key ID. Alternatively the controller may generate an encryption key store the encryption key in the encryption key table store the encryption key ID in the encryption key IDs and store an association between the encryption key ID and the encryption key table . The controller may utilize the encryption key to encrypt a file. The encrypted file may then be stored as a secure file in the public memory area .

In general the system agent file system toolkit may be used in connection with many different memory devices. The APIs allow a user to access data including the header portion of the secure file . The disclosed system and method extends usage of the header to store information to enhance performance to provide information related to content or for other purposes. For example metadata and location information related to trailer data may be stored in the header portion to provide ready access to limited data from the file content of the secure file without having to decrypt the entire secure file. The limited data may include information such as a media content title author length file type preview data other information or any combination thereof.

In a particular illustrative embodiment the memory device may include an API that is executable by the controller to request a file system to store the last sector location of a file into the header. Another API may be executed by the controller to read the last sector of a portion of the storage media For preloaded files the system agent file system toolkit may include a utility to build a metadata file related to the file content by extracting for example ID3 information for MP3 songs. The system agent file system toolkit can be utilized to build a pre loaded memory card by writing metadata into the header portion of the file that includes pre loaded media content e.g. audio content video content other content or any combination thereof . An example of such a pre loaded memory card is a GRUVI Card that is commercially available from SanDisk Corporation of Milpitas Calif.

In general the APIs may be executed by the controller to perform a variety of API functions. Examples of APIs that may be used include an API to store the metadata an API to retrieve the metadata an APT to store the location information related to trailer data or the trailer data and an API to retrieve the trailer data. The API to store the metadata has an input of a file name and the data structure of the metadata to be stored. The host device passes the file name and the metadata structure to the system agent file system toolkit which has been loaded by the controller . The system agent file system toolkit writes the metadata to a header portion of the file to be stored. In a particular embodiment the metadata structure and the metadata information include one or more of the following a content name an artist name an album name a genre a duration a copyright a description of content a frame number a time a bit rate a sample rate and a stereo indicator.

The APIs also include a retrieve metadata API that has a file name and the metadata structure as its inputs. The retrieve metadata API provides a status to indicate success or an error as its output. The retrieve metadata API is used to retrieve and fill the metadata structure. The retrieve metadata API is used by the host device that passes the file name and an empty metadata structure to the system agent file system toolkit . The system agent file system toolkit fills the metadata structure from the header portion of the stored secure file .

The APIs may also include a store trailer data API that receives a file name as its input. The store trailer data API provides a status output indicating that the store operation was successful or that the store operation encountered an error. The store trailer data API may provide a success code or an error code as its output. The store trailer data API is used by the host device which passes the file name to the system agent file system toolkit . The system agent file system toolkit retrieves the stored file information from a directory entry and determines a last sector location of the file. The store trailer data API then fills the trailer box and writes the trailer data to the header.

The APIs may also include a retrieve trailer data API that receives a file name a buffer size and a buffer as its inputs. The retrieve trailer data API provides a status indicator at its output. The retrieve trailer data API upon success fills the buffer and provides the length of the data in the buffer. During use of the retrieve trailer data API the host device passes the file name to the system agent file system toolkit . The system agent file system toolkit reads the trailer data of the header portion and retrieves the file information from the directory entry. The retrieve trailer data API then checks whether the secure file has been modified or moved. If the file information matches the header then the retrieve trailer data API uses the information to read the trailer data. The retrieve trailer data API then fills the buffer up to the buffer size and returns the filled buffer to the host device. If there is more data than will fit in the buffer due to a size limit the retrieve trailer data API returns a status to indicate that the buffer is too small for all of the trailer data. A user the host device or the controller may utilize the system agent file system toolkit and the above described APIs to store content into a secure memory area or to retrieve previously stored content. In addition an application running at the host device may use the APIs to retrieve requested content for playback.

The content file may include audio content video content text data multimedia content other data content or any combination thereof. The processor of the host device may execute software and read write applications to read and playback content from the content file. In a particular illustrative embodiment the memory device is adapted to manage encryption keys without providing the encryption keys to external components. The memory device may be adapted to utilize the encryption key identifiers provided by the host device or received from other devices to locate a key associated with selected media content and to manage the encryption decryption within the memory device .

In a particular illustrative embodiment the host device may communicate with a server at the service provider via the network . In a particular embodiment the network may be a local area network. In another particular embodiment the network may be a wide area network such as the Internet. The server at the service provider may provide media content to the host device and may communicate with the controller and or the system agent file system toolkit to generate control structures within the secure memory area of the storage media . The controller may utilize the control structures to manage and control access to particular media content stored at the storage media .

In an illustrative example the content portion of the secure file includes video data. The header portion has the location information related to trailer data that includes information related to the video data that is stored in a predetermined location of the secure file . For example the trailer data may include data from an end of file from a last sector or last data block of the file from a predetermined portion of the file from multiple portions of the file or any combination thereof. The header portion may include the location information related the end of the file the last sector or last data block of the file and so on. The video data may be provided to the host device for playback and display via the display device which may include audio reproduction capabilities. The processor can provide data related to the trailer data to the display device while authentication is being performed at the memory device while the secure file is being decrypted at the memory device or any combination thereof.

In a particular illustrative embodiment the host device may include a system agent file system toolkit such as the system agent file system toolkit for providing read and write access with respect to encrypted computer readable files. The processor of the host device can utilize the system agent file system toolkit to store location information related to the trailer data from a last sector of a content file into a header portion of the content file. The modified content file may then be encrypted and stored in the public memory area as a secure file . At a later time the processor of the host device can read the header portion of the secure file to obtain the data related to the content . The processor may provide data related to the header portion to the display device such as metadata via the display interface . The processor may also provide an encryption key ID to the controller which can utilize the encryption key IDs of the secure memory area to identify a decryption key and to decrypt the content portion of the secure file and provide decrypted content to the processor . In general the processor can provide information related to the data from the header portion to the display device before or during playback of the content from the public second memory area .

In general non volatile rewritable memory devices such as the memory device are particularly suitable for storing media content. For example flash memory cards have large storage capacities that can be used to store media content including movies video games audio data or any combination thereof. Furthermore since flash memory cards are rewritable such memory devices are more flexible compared to high capacity non rewritable memories such as compact discs. Once media content in non volatile rewritable memory devices can be securely protected and controlled by or on behalf of the content owner such as a copyright owner a content provider the service provider another entity or any combination thereof has new avenues for distributing media content. The end user will then be able to access the media content in such memory devices through different host devices without having to subscribe to multiple media services. Service providers such as the service provider can also derive additional revenue by being able to charge for the service of securely storing media content and distributing media content in a controlled manner.

For example a non volatile rewritable memory device such as the memory device may be pre loaded with data including encrypted media content and data related to the encrypted media content. In a particular illustrative embodiment the data related to the encrypted media content may include preview data such as unencrypted portions of the encrypted media content or unencrypted lower quality versions of such media content. The preview data may also include instructions to limit a number of plays or renderings of the full length media content.

In a particular illustrative embodiment the service provider may provide media content to the host device including preview data having playback restrictions. The content provider may include one or more servers that can provide a user interface accessible by the host device via the network to purchase unrestricted access rights to the encrypted media content. After the end user purchases the right to access the encrypted media titles the service provider may provide a key a control structure or other data to the host device for use by the controller to provide access to the media content. In this illustrative embodiment information associated with the host device can include credentials certificates other types of authentication information or any combination thereof. The information associated with the host device can also include information concerning access rights access rules playback rules media content sharing restrictions and or media content copying restrictions to control access to the encrypted media content that is available for preview. Encrypted media content associated with the preview data becomes available to the end user only after the purchase. In a particular embodiment the service provider can transmit an unabridged version of the encrypted media content to the host device after the purchase. In another particular embodiment the service provider can transmit a decryption key to the host device to allow the host device to decrypt the preloaded encrypted media content after the purchase.

In an alternative embodiment encrypted media content may be pre loaded into the above described non volatile rewritable memory device . Additionally access information including access rights access rules playback rules other control information or any combination thereof may be pre loaded into the memory device . The controller may utilize such access information to control access to the media content. The access information may specify that only selected portions of the encrypted media content lower quality versions of such media content text data related to the media content other data or any combination thereof may be accessible without restriction. Alternatively the access information may specify that particular media content may be played for only a limited number of times. The host device may be utilized by an end user to communicate purchase information to the service provider . The host device may receive updated access information which may be provided to the memory device to permit access to the secure file . Such access may be without further restriction or with more relaxed restrictions such as an increased number of times that the media content may be viewed.

In another particular illustrative example service providers may utilize non volatile rewritable memory devices such as the memory device with security features such as the control structure to control the distribution of media content including the secure file . Thus as another avenue for media distribution the memory device may be provided with security features that enable the service provider to create its own secure environment on the memory device . The service provider can create control structure that can be executed by the controller to control how the media content stored in the memory device is to be used. The control structure can take the form of a hierarchical tree which can be configured by the service provider to determine how the media content can be used and accessed at the memory device . The control structure can also take the form of an object referred to as a rights object. The rights object can include access rights and or access rules that are associated with specific media content and with certain authentication requirement s . In a particular illustrative embodiment access to the particular media content is granted when such authentication requirement s is satisfied and is controlled according to the access rights and or rules. With use of the control structure a number of applications may be able to access the same content without sharing keys or credentials. Further the control structure may allow the controller to delegate access rights to certain keys used to decrypt and or encrypt content.

The memory device communicates with the host device via the HIM and via the host interface bus . The HIM is suitable for communication with the host device which may be a digital camera a personal computer a personal digital assistants PDA a digital media players a portable media device such as an Motion Picture Experts Group Layer 3 MP3 media player a mobile communications device such as a mobile telephone other electronic devices or any combination thereof.

The flash memory which may be a NAND type flash memory can be used to provide data storage for the host device . The flash memory may be accessible to the CPU and software code that is executable by the CPU may be stored in flash memory . The CPU may include one or more CPU random access memories CPU RAMs . The flash memory may be accessible to the host device via the HIM the PAM and the FIM . The FIM communicates with the flash memory via a flash interface bus .

The BMU includes a host direct memory access DNA that communicates with the HIM . The host DMA allows the BMU to read and or write data from and to the HIM independent of the CPU . The DMA allows the BMU to transfer data to and from the host device via the HIM without incurring associated overhead at the CPU . The BMU also includes registers a flash direct memory access DMA an arbiter a buffer random access memory BRAM and a cryptographic crypto engine crypto engine . The arbiter can be a shared bus arbiter so that only one master or initiator which can be the host DMA the flash DMA or the CPU is allowed to be active at any time to communicate with the slave or target which is the BRAM . The arbiter channels the appropriate initiator request to the BRAM . The host DMA and the flash DMA are responsible for data transported between the HIM the FIM the BRAM the CPU random access memory CPU RAM or any combination thereof.

The BMU may also include a BMU to CPU interface that communicates information directly to the CPU RAM of the CPU . The BMU also includes a cryptographic key generator that can be used by the crypto engine to create cryptographic keys and to encrypt file data using the cryptographic keys in order to generate a secure file.

The flash memory may include a secure memory area that includes encryption key identifiers IDs . The flash memory may also include a public memory area that includes a secure file that has a header and content . The header can include metadata and location information related to trailer data associated with the content . Access to the secure file and to the secure area can be managed by the memory device .

The BRAM is used to store data passed between the host device and flash memory . For improved security of the content stored in the flash memory the memory device generates key value s that are used for encryption and or decryption. However encryption and decryption is typically performed on a file by file basis since the host device reads and writes data to memory device in the form of files. Like many other types of storage devices the memory device is not necessarily aware of files or file systems. While the flash memory does store a file allocation table FAT where the logical addresses of the files are identified the FAT is typically accessed and managed by the host device and not by the CPU . Therefore in order to encrypt data in a particular file the CPU may rely on the host device to send the logical addresses of the data associated with the file at the memory so that the data of the particular file can be found and encrypted and or decrypted by the memory device using the key value s available only to the memory device .

To provide a handle for both the host device and the memory device to refer to the same key s for cryptographically processing such data the host device provides a reference for each of the key values generated by memory device where such reference may be an encryption key ID. The memory device may access the secure area of the flash memory to determine an associated encryption key based on the key ID.

In general the host device associates each file that is cryptographically processed by memory device with an encryption key ID and a memory address. The memory device associates each key value that is used to cryptographically process data with the encryption key ID provided by the host device . When the host device requests that a file be cryptographically processed the host device sends a request to the memory device that includes an encryption key ID and logical addresses of data to be fetched from or to be stored at the memory device . The memory device generates a key value and associates the encryption key ID provided by the host with a generated key value. The memory device cryptographically processes the data fetched from or to be stored at the memory device . Thus the memory device can control the generation and management of the cryptographic key s and can control the associated cryptographic processing while allowing the host device to control the file address table FAT .

While the memory device is shown to include a flash memory in the form of memory card s the systems and methods disclosed herein may also be applicable to other types of storage media including magnetic storage media optical storage media or other types of rewritable non volatile storage media. Additionally the systems and methods disclosed herein may also be applicable to a variety of devices that access such storage media including computing devices portable media players portable communication devices personal digital assistants PDAs game systems other electronic devices or any combination thereof.

The encryption key ID provided by the host device and the key value generated by the memory device may form two attributes of a quantity referred to as the content encryption key or CEK. In a particular illustrative embodiment the host device may associate each encryption key ID with one or more files and or one or more file addresses within a file address table associated with the flash memory . In an embodiment the host device may also associate each encryption key ID with unorganized data unstructured data structured data semi structured data data organized in any manner or any combination thereof. Thus an encryption key ID may be associated with data that is not necessarily organized into a file structure.

In order for a user or application to gain access to protected content or a secure memory area of the memory the memory device may authenticate the user or application using a credential that may be pre registered with the memory device or pre loaded within a secure area of the memory . The credential can include a symmetric key a digital signature a digital certificate other indicia to provide authentication or any combination thereof. In a particular illustrative embodiment a credential may be associated with access rights granted to the particular user a particular device or a particular application. In a particular embodiment a credential may be an access code a password a serial number other data or any combination thereof. In the pre registration process the memory device stores a record of the identity and credential of the user device or application. The memory device may also store the access rights associated with such identity and credential as determined by the user or application and as provided via the host device . After the pre registration has been completed when the user or application requests to write data to the memory the user or application provides data related to its identity and credential an encryption key ID for encrypting the data and a logical address where the encrypted data is to be stored at the memory . The memory device generates a key value and associates this value with the encryption key ID provided by the host device and stores the encryption key ID for the key value used to encrypt the data in its record or table for this user or application. The memory device then encrypts the data and stores the encrypted data at the addresses designated by the host device . The memory device also stores the encryption key ID within a header portion of the data file. The memory device may also store encryption key ID data in a secure portion of the memory .

The content provider may provide media content which may be stored in a storage device which includes a secure memory area including encryption key identifiers IDs and includes a public memory area . The public memory area may include a secure file which includes a header portion having metadata and location information related to trailer data and having a content portion . The delivered media content from the content provider may be rendered by a variety of different end user terminals or hosts including the PDAs video game systems the mobile telephones the MP3 players and the computers which can include desktop computers portable computers or any combination thereof. Memory devices associated with each of the user terminals or hosts may include a secure storage area that can be configured by a service provider to provide avenues for media content distribution.

In general access to media content stored at the content servers may be restricted. The card management server can provide access rights and or access rules to the user terminals or hosts. The access rights and or access rules governing access to the encrypted media content in the card management server can apply when the media content is accessed by handsets by other types of terminals such as the media player and the computer . Content and rights and or rules may also be provided to the computer or to the mobile phone devices by a service provider such as a wireless network operator.

In the environment of a number of avenues using a memory system for storing and distributing media content are available. In one method a flash memory card manufacturer sells the memory card to a content issuer who also buys media content from a content provider and receives the rights object s for controlling such content from a rights objects server. Before such content and rights object s are loaded to the card the content issuer first verifies whether the card is genuine via a connection to an authentication server. The content and rights object s are loaded after the card has been authenticated. The authentication server may be provided at the content provider .

Thus the content issuer which may also be a card manufacturer sells the card to a service provider such as a mobile network operator. The service provider then sells the card together with an end user terminal such as a cellular phone handset provided by an Original Equipment Manufacturer referred to hereinafter as OEM to an end user. Before the content issuer sells the card to the service provider the content issuer may install control structures of the type described herein. Preferably such control structures are installed by the service provider as described to enable the service provider to create its own secure environment so that it can control content distribution. Before this happens the card is again verified to be genuine. Thus at the service provider s facility the card is again authenticated by connecting to the authentication server. The card is also connected via a terminal to an authorization server to enable or activate any particular features or applications e.g. media content rendering applications such as media players in the card. The service provider then installs a control structure to control access to the content in the card. The control structure provides that only authorized users may be able to access the content and such access will comply with certain permissions in the control structure or with certain rights and or rules.

Alternatively the content issuer may sell the card directly to the end user. The end user obtains a terminal such as a cellular phone handset from an OEM. Provided that such terminal and the card can mutually authenticate the end user will then be able to access the content stored in the memory card using the terminal. In this configuration the end user is provided with authentication information such as credentials user identifier password serial number etc. for accessing the content. The authentication process prevents others who are not provided with proper authentication to access the content in an unauthorized manner.

Alternatively where preview content is loaded to the card by the content issuer such content may also include encrypted unabridged versions of the media content. Thus when the end user purchases such cards the cards will have already stored the encrypted versions of the media content the user wishes to purchase. The cards will also have stored therein rights and or rules that restrict the end users rights to access only the abridged versions or portions of the content in the cards. In such circumstances there is no need to download such content to the card again. Instead all the end user will need are the content encryption keys for decrypting the media content and an update to the rights and or rules governing such access to permit unrestricted or more relaxed access. Such information can be downloaded from the rights issuer through the service provider after authentication.

In another embodiment content in the card can be accessed by the end user only after the end user subscribes to a service such as a service provided by the service provider. Thus the card purchased by the end user will contain control information which does not allow the end user to access the content until the end user has subscribed. The end user may first purchase the card from the content issuer but will not be able to access the media content therein until he or she has purchased a subscription from the service provider. Prior to the confirmation of the subscription the card in the end user s possession is verified to be genuine by the authentication server and the applications e.g. media content rendering applications such as media players are optionally enabled or activated by the authorization server. In the subscription process the rights object provided by the rights issuer is transmitted by the service provider to the end user for downloading to the card.

In an alternative method the card purchased by the end user will have no pre loaded media content. The end user will have to purchase the content from the service provider who in turn obtains content from the content provider server. As before prior to the loading of the content to the card the card is authenticated by the authentication server. Features and applications e.g. media content rendering applications such as media players are optionally enabled by the authorization server. As part of the transaction a rights object originating from the rights issuer is transmitted through the service provider to the end user for download to the card. While the card purchased by the end user may have no pre loaded media content the card may have rights object s stored therein which entitle the end user to download such content. This is then a prepaid media content card which enables the end user to repeatedly download content purchased.

Referring to a particular embodiment of a method of storing content in a non volatile memory is illustrated. The method includes reading a content file including media content and including a trailer at . The trailer includes trailer data related to the media content and may include metadata such as ID3 data. The method further includes storing location information related to the trailer data together with secure data in a header portion of a file such as a secure file at and storing the file to a storage element of either a non volatile memory or a memory area of a host device coupled to the non volatile memory device as shown at . The host device may be an electronic device that includes a processor and a memory such as a phone device a personal digital assistant PDA a laptop computer or a desktop computer. In a particular embodiment an application program interface API is used in connection with storing the trailer data together with the secure data in the header portion of the file. After the file is stored the content may be retrieved from memory and the media content may be provided to the host device for playback as shown at . Playback may include audio playback of audio content video playback of video content or multimedia playback of multimedia content.

In a particular illustrative embodiment a content provider may require the content stored at the non volatile memory to be protected. In this instance the protected content may be accessed using a secure session. For example a secure session may be established between the non volatile storage device and the host device. The non volatile storage device may decrypt the content using a content encryption key. The decrypted content may then be encrypted using a session key associated with the secure session. The encrypted data may be provided to the host device using the secure session. The host device can then decrypt the content using the session key. By utilizing secure session procedures the content may be secured when played back by the host device.

Referring to a particular embodiment of a method of retrieving content is illustrated. The method includes reading content from a non volatile memory at and reading location information related to trailer data associated with the content from a header portion of a secure file at . The header portion includes secure data items related to the content. The method further includes providing data related to the trailer data to a display device of a host device having access to the non volatile memory at . In a particular embodiment the host device has access to read the content for playback such as by using a playback program e.g. a media player . The content may include audio data video data or multimedia data. In a particular embodiment an application program interface API is used in connection with reading the trailer data from the header portion of the secure file. The host device may pass a file name and a metadata structure to a file system toolkit where the file system toolkit uses the API to write the metadata to the header portion of the secure file. The content may be played back at the host device as shown at . In addition metadata retrieved from the header may be used to display information related to the content on a display device at the host device such as display of a content title an artist name or other content related information on the host device. The display device may be a display on a cellular phone or an MP3 player or a display device coupled to a computer. As explained above a secure session may be used to protect the content for playback at the host device allowing the non volatile memory device to provide secured content to the host device without exposing encryption keys to the host device.

Referring to a method of accessing media content using a non volatile rewritable memory is illustrated. The method includes receiving information regarding access rights at and storing the access rights in a secure memory area of the non volatile rewritable memory. The access rights permit access to content decryption keys for decrypting encrypted media content stored in the non volatile rewritable memory at . The method further includes supplying a decrypted version of at least one selected encrypted media content item at and supplying metadata retrieved from a header portion of the secure memory area at . The metadata is associated with the at least one selected encrypted media content item. The decrypted version of the at least one selected encrypted media content may be provided to a host device. The host device may be a phone device a personal digital assistant PDA a computer or other similar device.

The method may also include receiving authentication information and decrypting the at least one selected encrypted media content item using content decryption keys after receiving the authentication information at . The host device may include a playback device for rendering the decrypted version of the at least one selected encrypted media content item. In a particular embodiment the method further includes connecting the host device to a server at sending a purchase authorization from the host device to the server at receiving information regarding the authentication information and receiving the access rights at the host device at and supplying the authentication information and the access rights to the non volatile rewriteable memory to permit access to selected encrypted media content items at .

Information related to the metadata retrieved from the header may be displayed as shown at and the decrypted version of the at least one selected encrypted media content item may be rendered while the host device concurrently displays information related to the metadata as shown at . For example a song title or an artist name may be displayed while an audio file for the song is being played on a host device.

Referring to a particular example of a data structure for a secure file is illustrated. The secure file may be stored on a computer readable medium such as a computer memory device. The secure file includes a header portion and a content portion . The content portion includes one or more media content items and trailer data . The header portion includes a secure data segment a metadata segment and a trailer data location . The secure data segment may include encryption key identifiers IDs hidden data or other data protection information.

Referring to a representative data structure of a header portion of a file is shown. The header portion includes a length field a type field a signature field a version field and padding . In a particular embodiment the header data structure can include a variable number of fields also known as boxes . Each of the fields or boxes includes a variable number of bytes of data with a four byte length in the front of each box.

Referring to a representative data structure for metadata that may be stored within a header is shown. The metadata includes a length field a type field a content name length field a content name padding field an artist name length field an artist name padding field an album name length field an album name padding field a genre subscriber length field a genre subscriber padding field a length of other items field and other sub boxes for other items . The type field may in a particular example include the designator mdat to identify metadata. Also in a particular illustrative embodiment the length of the content name the length of the artist name and the length of the album name may each be 64 bytes. Through use of the metadata data structure within the header portion metadata for associated content files such as audio or video files can be conveniently stored in a manner for fast access and subsequent display during playback of the content file. This method provides for efficient storage and retrieval of the metadata for encrypted content files that have been stored in a memory such as a non volatile memory device.

Referring to a data structure for trailer data that may be stored within a header portion of a file is shown. The trailer data structure includes a length field a type field a flag a number of sectors field a recording date time field a cluster number of a first sector of the file field a cluster number of the trailer field a next cluster of the trailer if exists field a sector offset field and a byte offset field . In a particular illustrative embodiment the length of the box for trailer information is 4 bytes and the box type field is filled with the indicator Idat to designate trailer data. The flag field may include a first bit that indicates whether the trailer is aligned with a sector boundary and a second bit that indicates whether the trailer contains more than one sector up to the maximum number of sectors in a cluster. The recording date time field is used to check if the file has been moved or is a copy of a file with a trailer box. The traditional file seek operation will be performed if the user has done a move or copy on a personal computer. The next cluster field is used to identify a next cluster if the trailer data is spread across two different clusters. The two clusters may not be contiguous.

The trailer data structure provides information including specific cluster sector and byte location information of the trailer data for the file. By storing trailer data location information in a header portion of the file a host device can quickly and efficiently access the trailer data from the header instead of requiring a file system to go through a large and lengthy search of many encrypted files to retrieve particular trailer data. Thus the method and system disclosed provide faster and more efficient access to retrieve trailer data for encrypted content files.

The illustrations of the embodiments described herein are intended to provide a general understanding of the structure of the various embodiments. The illustrations are not intended to serve as a complete description of all of the elements and features of apparatus and systems that utilize the structures or methods described herein. Many other embodiments may be apparent to those of skill in the art upon reviewing the disclosure. Other embodiments may be utilized and derived from the disclosure such that structural and logical substitutions and changes may be made without departing from the scope of the disclosure. Additionally the illustrations are merely representational and may not be drawn to scale. Certain proportions within the illustrations may be exaggerated while other proportions may be reduced. Although specific embodiments have been illustrated and described herein it should be appreciated that any subsequent arrangement designed to achieve the same or similar purpose may be substituted for the specific embodiments shown. This disclosure is intended to cover any and all subsequent adaptations or variations of various embodiments. Combinations of the above embodiments and other embodiments not specifically described herein will be apparent to those of skill in the art upon reviewing the description. Accordingly the disclosure and the figures are to be regarded as illustrative rather than restrictive.

The Abstract of the Disclosure is submitted with the understanding that it will not be used to interpret or limit the scope or meaning of the claims. In addition in the foregoing Detailed Description various features may be grouped together or described in a single embodiment for the purpose of streamlining the disclosure. This disclosure is not to be interpreted as reflecting an intention that the claimed embodiments require more features than are expressly recited in each claim. Rather as the following claims reflect inventive subject matter may be directed to less than all of the features of any of the disclosed embodiments. Thus the following claims are incorporated into the Detailed Description with each claim standing on its own as defining separately claimed subject matter.

The above disclosed subject matter is to be considered illustrative and not restrictive and the appended claims are intended to cover all such modifications enhancements and other embodiments which fall within the true spirit and scope of the present invention. Thus to the maximum extent allowed by law the scope of the present invention is to be determined by the broadest permissible interpretation of the following claims and their equivalents and shall not be restricted or limited by the foregoing detailed description.

