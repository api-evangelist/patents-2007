---

title: Adaptive selection of picture-level quantization parameters for predicted video pictures
abstract: Techniques and tools for adaptive selection of picture quantization parameters (“QPs”) for predicted pictures are described. For example, a video encoder adaptively selects a delta QP for a B-picture based on spatial complexity, temporal complexity, whether differential quantization is active, whether the B-picture is available as a reference picture, or some combination or subset of these or other factors. The delta QP can then be used to adjust the picture QP for the B-picture (e.g., to reduce bit rate for the B-picture without appreciably reducing the perceived quality of a video sequence.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08331438&OS=08331438&RS=08331438
owner: Microsoft Corporation
number: 08331438
owner_city: Redmond
owner_country: US
publication_date: 20070605
---
With the increasing popularity of DVDs music and video delivery over the Internet and digital cameras digital media have become commonplace. Engineers use a variety of techniques to process digital audio video and images efficiently while still maintaining quality. To understand these techniques it helps to understand how the audio video and image information is represented and processed in a computer.

A computer processes media information as a series of numbers representing that information. For example a single number may represent the intensity of brightness or the intensity of a color component such as red green or blue for each elementary small region of a picture so that the digital representation of the picture consists of one or more arrays of such numbers. Each such number may be referred to as a sample. For a color image it is conventional to use more than one sample to represent the color of each elemental region and typically three samples are used. The set of these samples for an elemental region may be referred to as a pixel where the word pixel is a contraction referring to the concept of a picture element. For example one pixel may consist of three samples that represent the intensity of red green and blue light necessary to represent the elemental region. Such a pixel type is referred to as an RGB pixel. Several factors affect quality of media information including sample depth resolution and frame rate for video .

Sample depth is a property normally measured in bits that indicates the range of numbers that can be used to represent a sample. When more values are possible for the sample quality can be higher because the number can capture more subtle variations in intensity and or a greater range of values. Resolution generally refers to the number of samples over some duration of time for audio or space for images or individual video pictures . Images with higher resolution tend to look crisper than other images and contain more discernable useful details. Frame rate is a common term for temporal resolution for video. Video with higher frame rate tends to mimic the smooth motion of natural objects better than other video and can similarly be considered to contain more detail in the temporal dimension. For all of these factors the tradeoff for high quality is the cost of storing and transmitting the information in terms of the bit rate necessary to represent the sample depth resolution and frame rate as Table 1 shows.

Despite the high bit rate necessary for storing and sending high quality video such as HDTV companies and consumers increasingly depend on computers to create distribute and play back high quality content. For this reason engineers use compression also called source coding or source encoding to reduce the bit rate of digital media. Compression decreases the cost of storing and transmitting the information by converting the information into a lower bit rate form. Compression can be lossless in which quality of the video does not suffer but decreases in bit rate are limited by the complexity of the video. Or compression can be lossy in which quality of the video suffers but decreases in bit rate are more dramatic. Decompression also called decoding reconstructs a version of the original information from the compressed form. An encoder decoder system is sometimes referred to as a codec. 

In general video compression techniques include intra compression and inter or predictive compression. For video frames intra compression techniques compress individual frames typically called I frames or key frames. Inter compression techniques compress frames with reference to preceding and or following frames and inter compressed frames are typically called predicted frames P frames or B frames.

Microsoft Corporation s Windows Media Video Version 8 WMV8 includes a video encoder and a video decoder. The WMV8 encoder uses intra and inter compression and the WMV8 decoder uses intra and inter decompression. Windows Media Video Version 9 WMV9 uses a similar architecture for many operations.

The encoder then quantizes the DCT coefficients resulting in an 8 8 block of quantized DCT coefficients . Quantization is lossy. Since low frequency DCT coefficients tend to have higher values quantization typically results in loss of precision but not complete loss of the information for the coefficients. On the other hand since high frequency DCT coefficients tend to have values of zero or close to zero quantization of the high frequency coefficients typically results in contiguous regions of zero values. In addition in some cases high frequency DCT coefficients are quantized more coarsely than low frequency DCT coefficients resulting in greater loss of precision information for the high frequency DCT coefficients.

The encoder then prepares the 8 8 block of quantized DCT coefficients for entropy encoding which is a form of lossless compression. The exact type of entropy encoding can vary depending on whether a coefficient is a DC coefficient lowest frequency an AC coefficient other frequencies in the top row or left column or another AC coefficient.

The encoder encodes the DC coefficient as a differential from the DC coefficient of a neighboring 8 8 block which is a previously encoded neighbor e.g. top or left of the block being encoded. shows a neighbor block that is situated to the left of the block being encoded in the frame. The encoder entropy encodes the differential.

The entropy encoder can encode the left column or top row of AC coefficients as a differential from a corresponding left column or top row of the neighboring 8 8 block. This is an example of AC coefficient prediction. shows the left column of AC coefficients encoded as a differential from the left column of the neighboring in reality to the left block . The differential coding increases the chance that the differential coefficients have zero values. The remaining AC coefficients are from the block of quantized DCT coefficients.

The encoder scans the 8 8 block of quantized AC DCT coefficients into a one dimensional array and then entropy encodes the scanned AC coefficients using a variation of run length coding . The encoder selects an entropy code from one or more run level last tables and outputs the entropy code.

Inter compression in the WMV8 encoder uses block based motion compensated prediction coding followed by transform coding of the residual error. illustrate the block based inter compression for a predicted frame in the WMV8 encoder. In particular illustrates motion estimation for a predicted frame and illustrates compression of a prediction residual for a motion compensated block of a predicted frame.

For example in the WMV8 encoder computes a motion vector for a macroblock in the predicted frame . To compute the motion vector the encoder searches in a search area of a reference frame . Within the search area the encoder compares the macroblock from the predicted frame to various candidate macroblocks in order to find a candidate macroblock that is a good match. The encoder outputs information specifying the motion vector entropy coded for the matching macroblock. The motion vector is differentially coded with respect to a motion vector predictor. The prediction is rarely perfect so the encoder usually encodes blocks of differences also called the error or residual blocks between the prediction macroblock and the macroblock itself.

The preceding section mentioned quantization a mechanism for lossy compression and lossless compression. Lossless compression reduces the bit rate of information by removing redundancy from the information without any reduction in fidelity. Lossless compression techniques reduce bit rate at no cost to quality but can only reduce bit rate up to a certain point. Decreases in bit rate are limited by the inherent amount of variability in the statistical characterization of the input data which is referred to as the source entropy.

In contrast with lossy compression the quality suffers somewhat but the achievable decrease in bit rate is more dramatic. Lossy compression techniques can be used to reduce bit rate more than lossless compression techniques but some of the reduction in bit rate is achieved by reducing quality and the lost quality cannot be completely recovered. Lossy compression is often used in conjunction with lossless compression e.g. in a system design in which lossy compression establishes an approximation of the information and lossless compression techniques are applied to represent the approximation.

According to one possible definition quantization is a term used for an approximating non reversible mapping function commonly used for lossy compression in which there is a specified set of possible output values and each member of the set of possible output values has an associated set of input values that result in the selection of that particular output value. In general an encoder varies quantization to trade off quality and bit rate. Coarser quantization results in greater quality reduction but allows for greater bit rate reduction.

In many systems the extent of quantization is measured in terms of quantization step size. Coarser quantization uses larger quantization step sizes corresponding to wider ranges of input values. Finer quantization uses smaller quantization step sizes. Often for purposes of signaling and reconstruction quantization step sizes are parameterized as multiples of a smallest quantization step size. Quantization step sizes may be represented by quantization indexes.

Different reconstruction rules may be used to determine the reconstruction value for each quantization index. Standards and product specifications that focus only on achieving interoperability will often specify reconstruction values without necessarily specifying the classification rule. In other words some specifications may define the functional mapping k k without defining the functional mapping x A x . This allows a decoder built to comply with the standard specification to reconstruct information correctly. In contrast encoders are often given the freedom to change the classifier in any way that they wish while still complying with the standard specification.

A variety of quantization techniques have been developed including scalar or vector uniform or non uniform and adaptive or non adaptive quantization.

According to one possible definition a scalar quantizer is an approximating functional mapping x Q x of an input value x to a quantized value Q x sometimes called a reconstructed value. shows a staircase I O function for a scalar quantizer. The horizontal axis is a number line for a real number input variable x and the vertical axis indicates the corresponding quantized values Q x . The number line is partitioned by thresholds such as the threshold . Each value of x within a given range between a pair of adjacent thresholds is assigned the same quantized value Q x . For example each value of x within the range is assigned the same quantized value . At a threshold one of the two possible quantized values is assigned to an input x depending on the system. Overall the quantized values Q x exhibit a discontinuous staircase pattern. The distance the mapping continues along the number line depends on the system typically ending after a finite number of thresholds. The placement of the thresholds on the number line may be uniformly spaced as shown in or non uniformly spaced.

A scalar quantizer can be decomposed into two distinct stages. The first stage is the classifier stage in which a classifier function mapping x A x maps an input x to a quantization index A x which is often integer valued. In essence the classifier segments an input number line or data set. shows a generalized classifier and thresholds for a scalar quantizer. As in a number line for a real number variable x is segmented by thresholds such as the threshold . Each value of x within a given range such as the range is assigned the same quantized value Q x . shows a numerical example of a classifier and thresholds for a scalar quantizer.

In the second stage a reconstructor functional mapping k k maps each quantization index k to a reconstruction value k . In essence the reconstructor places steps having a particular height relative to the input number line segments or selects a subset of data set values for reconstruction of each region determined by the classifier. The reconstructor functional mapping may be implemented for example using a lookup table. Overall the classifier relates to the reconstructor as follows Q x A x 1 .

In common usage the term quantization is often used to describe the classifier stage which is performed during encoding. The term inverse quantization is similarly used to describe the reconstructor stage whether performed during encoding or decoding.

The distortion introduced by using such a quantizer may be computed with a difference based distortion measure d x Q x . Typically such a distortion measure has the property that d x Q x increases as x Q x deviates from zero and typically each reconstruction value lies within the range of the corresponding classification region so that the straight line that would be formed by the functional equation Q x x will pass through every step of the staircase diagram as shown in and therefore Q Q x will typically be equal to Q x . In general a quantizer is considered better in rate distortion terms if the quantizer results in a lower average value of distortion than other quantizers for a given bit rate of output.

A non uniform quantizer has threshold values that are not uniformly spaced for all classifier regions. According to one possible definition a dead zone plus uniform threshold quantizer DZ UTQ is a quantizer with uniformly spaced threshold values for all classifier regions except the one containing the zero input value which is called the dead zone . In a general sense a DZ UTQ is a non uniform quantizer since the dead zone size is different than the other classifier regions.

A DZ UTQ has a classifier index mapping rule x A x that can be expressed based on two parameters. shows a staircase I O function for a DZ UTQ and shows a generalized classifier and thresholds for a DZ UTQ. The parameter s which is greater than 0 indicates the step size for all steps other than the dead zone. Mathematically all sare equal to s for i 0. The parameter z which is greater than or equal to 0 indicates the ratio of the dead zone size to the size of the other steps. Mathematically s z s. In z is 2 so the dead zone is twice as wide as the other classification zones. The index mapping rule x A x for a DZ UTQ can be expressed as 

As mentioned above lossy compression tends to cause a decrease in quality. For example a series of ten samples of slightly different values can be approximated using quantization as ten samples with exactly the same particular approximate value.

This kind of quantization can reduce the bit rate of encoding the series of ten samples but at the cost of lost detail in the original ten samples.

In some cases quantization produces visible artifacts that tend to be more artificial looking and visually distracting than simple loss of fine detail. For example smooth un textured content is susceptible to contouring artifacts artifacts that appear between regions of two different quantization output values because the human visual system is sensitive to subtle variations particularly luma differences in smooth content.

Another perceptual effect of quantization occurs when average quantization step sizes are varied between frames in a sequence. Although the flexibility to change quantization step sizes can help control bit rate an unpleasant flicker effect can occur when average quantization step sizes vary too much from frame to frame and the difference in quality between frames becomes noticeable. Furthermore devoting too much bit rate to frames or regions that are not perceptually important can cause shortages in available bit rate for more important frames or regions.

VC 1 is a video codec standard that specifies certain rules for inverse uantization. The encoder sends a picture level bitstream element PQINDEX to indicate a base quantization step size also referred to herein as a quantization parameter or QP for the picture picture QP . PQINDEX is present for all picture types including I pictures P pictures and B pictures. Although VC 1 does not specify how the value of PQINDEX should be determined for different pictures the value of PQINDEX and therefore the QP for the picture can vary for different picture types. Typically lower QPs are used for I pictures and higher QPs are used for predicted pictures.

In differential quantization the encoder varies QPs for different parts of a picture. Typically this involves varying QPs on a macroblock level or other sub picture level. The encoder makes decisions on how to vary the QPs and signals those decisions as appropriate to a decoder. In VC 1 the encoder sends a bitstream element DQUANT at a syntax level above picture level to indicate differential quantization status. If DQUANT 0 the QP indicated by PQINDEX is used for all macroblocks in the picture. If DQUANT 1 or 2 different macroblocks in the same picture can use different QPs.

A VC 1 encoder can use more than one approach to differential quantization. In one approach only two different QPs are used for a picture. This is referred to as bi level differential quantization. For example one QP is used for macroblocks at picture edges and another QP is used for macroblocks in the rest of the picture. This can be useful for saving bits at picture edges where fine detail is less important for maintaining overall visual quality. Or a 1 bit value signaled per macroblock indicates which of two available QP values to use for the macroblock. In another approach referred to as multi level differential quantization a larger number of different QPs can be used for individual macroblocks in a picture.

Various video standards allow the use of different quantization step sizes for different picture types and allow variation of quantization step sizes for rate and quality control. Standards typically do not fully specify the quantizer design.

Numerous systems for adjusting quantization thresholds have been developed. Many standards and products specify reconstruction values that correspond to a typical mid point reconstruction rule e.g. for a typical simple classification rule for the sake of simplicity. For classification however the thresholds can in fact be adjusted so that certain input values will be mapped to more common and hence lower bit rate indices which makes the reconstruction values closer to optimal.

Numerous international standards specify aspects of video decoders and formats for compressed video information. Directly or by implication these standards also specify certain encoder details but other encoder details are not specified. Some standards address still image compression decompression and other standards address audio compression decompression. Numerous companies have produced encoders and decoders for audio still images and video. Various other kinds of signals for example hyperspectral imagery graphics text financial information etc. are also commonly represented and stored or transmitted using compression techniques.

Given the critical importance of compression to digital video it is not surprising that video compression is a richly developed field. Whatever the benefits of previous video compression techniques however they do not have the advantages of the following techniques and tools.

The present application describes techniques and tools for adaptive selection of picture quantization parameters QPs for predicted pictures. For example a video encoder adaptively selects a delta QP for a B picture based on spatial complexity temporal complexity whether differential quantization is active whether the B picture is available as a reference picture or some combination or subset of these or other factors. The delta QP can then be used to adjust the picture QP for the B picture e.g. to reduce bit rate for the B picture without appreciably reducing the perceived quality of a video sequence .

This Summary is provided to introduce a selection of concepts in a simplified form that are further described below in the Detailed Description. This Summary is not intended to identify key features or essential features of the claimed subject matter nor is it intended to be used to limit the scope of the claimed subject matter.

The foregoing and other objects features and advantages of the invention will become more apparent from the following detailed description which proceeds with reference to the accompanying figures.

The present application relates to techniques and tools for efficient compression of video. In various described embodiments a video encoder incorporates techniques for encoding video and corresponding signaling techniques for use with a bitstream format or syntax comprising different layers or levels. Described techniques and tools can be applied to interlaced or progressive frames. A decoder can perform corresponding decoding.

Various alternatives to the implementations described herein are possible. For example techniques described with reference to flowchart diagrams can be altered by changing the ordering of stages shown in the flowcharts by repeating or omitting certain stages etc. As another example although some implementations are described with reference to specific macroblock formats other formats also can be used.

The various techniques and tools can be used in combination or independently. Different embodiments implement one or more of the described techniques and tools. Some techniques and tools described herein can be used in a video encoder or in some other system not specifically limited to video encoding.

With reference to the computing environment includes at least one processing unit and memory . In this most basic configuration is included within a dashed line. The processing unit executes computer executable instructions and may be a real or a virtual processor. In a multi processing system multiple processing units execute computer executable instructions to increase processing power. The memory may be volatile memory e.g. registers cache RAM non volatile memory e.g. ROM EEPROM flash memory etc. or some combination of the two. The memory stores software implementing a video encoder or post encoding application with one or more of the described techniques and tools for adaptive quantization.

A computing environment may have additional features. For example the computing environment includes storage one or more input devices one or more output devices and one or more communication connections . An interconnection mechanism not shown such as a bus controller or network interconnects the components of the computing environment . Typically operating system software not shown provides an operating environment for other software executing in the computing environment and coordinates activities of the components of the computing environment .

The storage may be removable or non removable and includes magnetic disks magnetic tapes or cassettes CD ROMs DVDs or any other medium which can be used to store information and which can be accessed within the computing environment . The storage stores instructions for the software .

The input device s may be a touch input device such as a keyboard mouse pen or trackball a voice input device a scanning device or another device that provides input to the computing environment . For audio or video encoding the input device s may be a sound card video card TV tuner card or similar device that accepts audio or video input in analog or digital form or a DVD CD ROM or CD RW that reads audio or video samples into the computing environment . The output device s may be a display printer speaker DVD or CD writer or another device that provides output from the computing environment .

The communication connection s enable communication over a communication medium to another computing entity. The communication medium conveys information such as computer executable instructions audio or video input or output or other data in a modulated data signal. A modulated data signal is a signal that has one or more of its characteristics set or changed in such a manner as to encode information in the signal. By way of example and not limitation communication media include wired or wireless techniques implemented with an electrical optical RF infrared acoustic or other carrier.

The techniques and tools can be described in the general context of computer readable media. Computer readable media are any available media that can be accessed within a computing environment. By way of example and not limitation with the computing environment computer readable media include memory storage communication media and combinations of any of the above.

The techniques and tools can be described in the general context of computer executable instructions such as those included in program modules being executed in a computing environment on a target real or virtual processor. Generally program modules include routines programs libraries objects classes components data structures etc. that perform particular tasks or implement particular abstract data types. The functionality of the program modules may be combined or split between program modules as desired in various embodiments. Computer executable instructions for program modules may be executed within a local or distributed computing environment.

For the sake of presentation the detailed description uses terms like receive and select to describe computer operations in a computing environment. These terms are high level abstractions for operations performed by a computer and should not be confused with acts performed by a human being. The actual computer operations corresponding to these terms vary depending on implementation.

The encoder processes video pictures. The term picture generally refers to source coded or reconstructed image data. For progressive video a picture is a progressive Video frame. For interlaced video a picture may refer to an interlaced video frame the top field of the frame or the bottom field of the frame depending on the context. The encoder is block based and uses a 4 2 0 macroblock format for frames. As shown in macroblock includes four 8 8 luminance or luma blocks Y through Y and two 8 8 chrominance or chroma blocks U and V that are co located with the four luma blocks but half resolution horizontally and vertically following the conventional 4 2 0 macroblock format. For fields the same or a different macroblock organization and format may be used. The 8 8 blocks may be further sub divided at different stages e.g. at the frequency transform and entropy encoding stages. The encoder can perform operations on sets of samples of different size or configuration than 8 8 blocks and 16 16 macroblocks. Alternatively the encoder is object based or uses a different macroblock or block format.

Returning to the encoder system compresses predicted pictures and intra coded key pictures. For the sake of presentation shows a path for key pictures through the encoder system and a path for predicted pictures. Many of the components of the encoder system are used for compressing both key pictures and predicted pictures. The exact operations performed by those components can vary depending on the type of information being compressed.

A predicted picture e.g. progressive P frame or B frame interlaced P field or B field or interlaced P frame or B frame is represented in terms of prediction or difference from one or more other pictures which are typically referred to as reference pictures or anchors . A prediction residual is the difference between what was predicted and the original picture. In contrast a key picture e.g. progressive I frame interlaced I field or interlaced I frame is compressed without reference to other pictures.

If the current picture is a predicted picture a motion estimator estimates motion of macroblocks or other sets of samples of the current picture with respect to one or more reference pictures for example the reconstructed previous picture buffered in the picture store . If the current picture is a bi predictive picture a motion estimator estimates motion in the current picture with respect to up to four reconstructed reference pictures for an interlaced B field for example . Typically a motion estimator estimates motion in a B picture with respect to one or more temporally previous reference pictures and one or more temporally future reference pictures but B pictures need not be predicted from different temporal directions. The encoder system can use the separate stores for multiple reference pictures.

The motion estimator can estimate motion by full sample sample sample or other increments and can switch the precision of the motion estimation on a picture by picture basis or other basis. The motion estimator and compensator also can switch between types of reference picture sample interpolation e.g. between bicubic and bilinear on a per frame or other basis. The precision of the motion estimation can be the same or different horizontally and vertically. The motion estimator outputs as side information motion information such as differential motion vector information. The encoder encodes the motion information by for example computing one or more predictors for motion vectors computing differentials between the motion vectors and predictors and entropy coding the differentials. To reconstruct a motion vector a motion compensator combines a predictor with differential motion vector information.

The motion compensator applies the reconstructed motion vector to the reconstructed picture s to form a motion compensated current picture . The prediction is rarely perfect however and the difference between the motion compensated current picture and the original current picture is the prediction residual . During later reconstruction of the picture the prediction residual is added to the motion compensated current picture to obtain a reconstructed picture that is closer to the original current picture . In lossy compression however some information is still lost from the original current picture . Alternatively a motion estimator and motion compensator apply another type of motion estimation compensation.

A frequency transformer converts the spatial domain video information into frequency domain i.e. spectral data. For block based video pictures the frequency transformer applies a DCT variant of DCT or other block transform to blocks of the sample data or prediction residual data producing blocks of frequency transform coefficients. Alternatively the frequency transformer applies another conventional frequency transform such as a Fourier transform or uses wavelet or sub band analysis. The frequency transformer may apply an 8 8 8 4 4 8 4 4 or other size frequency transform.

A quantizer then quantizes the blocks of spectral data coefficients. The quantizer applies uniform scalar quantization to the spectral data with a step size that varies on a picture by picture basis or other basis e.g. a macroblock by macroblock basis . Alternatively the quantizer applies another type of quantization to the spectral data coefficients for example a non uniform vector or non adaptive quantization or directly quantizes spatial domain data in an encoder system that does not use frequency transformations. Techniques and tools relating to quantization in some implementations are described in detail below.

In addition to adaptive quantization the encoder can use frame dropping adaptive filtering or other techniques for rate control.

When a reconstructed current picture is needed for subsequent motion estimation compensation an inverse quantizer performs inverse quantization on the quantized spectral data coefficients. An inverse frequency transformer then performs the inverse of the operations of the frequency transformer producing a reconstructed prediction residual for a predicted picture or a reconstructed key picture. If the current picture was a key picture the reconstructed key picture is taken as the reconstructed current picture not shown . If the current picture was a predicted picture the reconstructed prediction residual is added to the motion compensated current picture to form the reconstructed current picture. One or both of the picture stores buffers the reconstructed current picture for use in motion compensated prediction. In some embodiments the encoder applies a de blocking filter to the reconstructed frame to adaptively smooth discontinuities and other artifacts in the picture.

The entropy coder compresses the output of the quantizer as well as certain side information e.g. motion information quantization step size QP . Typical entropy coding techniques include arithmetic coding differential coding Huffman coding run length coding LZ coding dictionary coding and combinations of the above. The entropy coder typically uses different coding techniques for different kinds of information e.g. DC coefficients AC coefficients different kinds of side information and can choose from among multiple code tables within a particular coding technique. The encoder may use special signaling for a skipped macroblock which is a macroblock that has no information of certain types e.g. no differential motion vectors for the macroblock and no residual information .

The entropy coder provides compressed video information to the buffer . A buffer level indicator may be fed back to a controller. Before or after the buffer the compressed video information can be channel coded for transmission over the network. The channel coding can apply error detection and correction data to the compressed video information .

A controller not shown receives inputs from various modules such as the motion estimator frequency transformer quantizer inverse quantizer entropy coder and buffer . The controller evaluates intermediate results during encoding for example estimating distortion and performing other rate distortion analysis. The controller works with modules such as the motion estimator frequency transformer quantizer and entropy coder to set and change coding parameters during encoding. When an encoder evaluates different coding parameter choices during encoding the encoder may iteratively perform certain stages e.g. quantization and inverse quantization to evaluate different parameter settings. The encoder may set parameters at one stage before proceeding to the next stage. Or the encoder may jointly evaluate different coding parameters. The tree of coding parameter decisions to be evaluated and the timing of corresponding encoding depends on implementation.

The encoder may include one or more modules for using regions of interest to adjust encoder settings. For example the encoder can allow a user to preview video after quantization or other encoding stages and draw regions of interest to indicate areas for quality adjustment. Alternatively region of interest adjustments can be made after the encoder outputs encoded video.

The relationships shown between modules within the encoder indicate general flows of information in the encoder other relationships are not shown for the sake of simplicity. In particular usually does not show side information indicating the encoder settings modes tables etc. used for a video sequence picture macroblock block etc. Such side information once finalized is sent in the output bitstream typically after entropy encoding of the side information.

Particular embodiments of video encoders typically use a variation or supplemented version of the generalized encoder . Depending on implementation and the type of compression desired modules of the encoder can be added omitted split into multiple modules combined with other modules and or replaced with like modules. For example the controller can be split into multiple controller modules associated with different modules of the encoder. In alternative embodiments encoders with different modules and or other configurations of modules perform one or more of the described techniques.

Multiple pass video encoders generally perform a first encoding on video data in order to determine statistics about the video data. By using information gained during a first pass analysis multiple pass encoding systems are able to perform processing and encoding that is more accurately directed toward the particular nature of the video being encoded. This tuning of the process can result in an encoded video stream that either has a lower bit rate fewer visible artifacts or both at a cost of increased processing time compared to single pass encoding on the encoder side.

Video complexity can be measured for example in terms of spatial complexity and temporal complexity. Spatial complexity generally refers to the amount of busyness or detailed texture in a picture or group of pictures. Temporal complexity generally refers to the amount and nature of motion in a group of pictures. Where motion is high such as in a fast motion scene and or difficult to predict e.g. falling snow or a wind blown water surface temporal complexity is high.

Referring again to the system determines complexity parameters from the collected information. For example the system performs the technique of or some other technique to determine the complexity parameters. The system encodes the video data based on the complexity parameters in the second encoding pass . The system can then output an encoded video stream. Alternatively a single pass encoding system is used.

In the example technique a quantization value and frame size are determined for an I picture in a group of pictures. Determining the quantization value may involve simply looking up a picture QP for the I picture e.g. where differential quantization is not being used . When different QPs are used within the I picture an average QP median QP minimum QP maximum QP or some other quantization value can be used. The quantization value and frame size for the I picture are multiplied and this product is set as the spatial complexity parameter for the group of pictures. Thus in this example for a quantization value and frame size for the I picture QVand Size respectively a spatial complexity parameter C used for every frame in the group of pictures is calculated as follows Size 4 . Alternatively one or both of the quantization value and frame size may be scaled up or down or otherwise adjusted before calculating a spatial complexity parameter. Measurements of spatial complexity can consider other factors such as texture information e.g. information that indicates whether a given region is smooth has sharp edges or is highly textured in addition to or in place of factors such as picture QP and frame size.

In the example technique a P picture is selected and a quantization value and frame size are determined for the P picture being analyzed. Determining the quantization value may involve simply looking up a picture QP for the P picture e.g. where differential quantization is not being used . When different QPs are used within the P picture an average QP median QP minimum QP maximum QP or some other quantization value can be used. The quantization value and frame size for the P picture are multiplied . Thus in this example for a quantization value and frame size for the P picture QVand Size respectively a first temporal complexity parameter C is calculated for the P picture as follows Size 5 . While the calculation of C in Equation 5 does capture the general concept that lower temporal complexity should lead to a smaller frame size at a given QP experiments show that C is also related to spatial complexity given the same amount of motion and the same QP a scene with higher spatial complexity is likely to have larger frame sizes for P pictures compared to a scene with lower spatial complexity.

In the example shown in to account for this correlation C is divided by the spatial complexity parameter for the group of pictures which can be obtained using the technique illustrated in . This potentially more accurate measure for the temporal complexity of the P picture can be calculated as follows 

To obtain a single temporal complexity parameter for the group of pictures an average or median minimum maximum or some other synthesis of the temporal complexity parameters for P pictures can be calculated and set as the temporal complexity parameter for the group of pictures.

For more information on measuring spatial and temporal complexity and on multi pass encoding in some implementations see U.S. patent application Ser. No. 11 673 516 filed on Feb. 9 2007.

Estimated complexity can be used to make better encoding decisions in other encoding and preprocessing modules. For example an encoding system can use complexity parameters to adjust quantization such as by adjusting quantization dead zones or selecting delta QPs for P pictures or B pictures based at least in part on the complexity parameters as described below.

Under one possible measure of video quality video encoders aim to achieve a desired quality level over entire video sequences rather than focusing solely on the quality of individual pictures. To help maintain quality over sequences of pictures it is important for encoders to make good decisions as to how many bits to use on particular pictures of different types. A poor bit allocation scheme may cause an encoder to use too many bits encoding some pictures and not enough bits encoding others.

In general the quality of reference pictures in a sequence directly affects the quality of the entire sequence. Therefore it is important for encoders to allocate enough bits for I pictures and P pictures to maintain high quality because I pictures and P pictures are often used as motion compensation references for other pictures. Encoding artifacts that appear in individual I pictures and P pictures are likely to be propagated to other pictures but this is not the case for B pictures that are not used as reference pictures.

When encoding video overall coding quality can be improved if fewer bits are allocated to B pictures than to I pictures and P pictures. Unlike I pictures and P pictures B pictures are generally not used as reference pictures for other pictures in motion compensation. For this reason slightly reducing the quality of B pictures e.g. by increasing a quantization step size will not affect the quality of other frames. In addition quality gains from spending more bits encoding B pictures e.g. by using smaller quantization step sizes are generally not as significant as quality gains from spending those bits encoding I pictures and P pictures. Therefore quality often can be improved by saving bits in B pictures and using the saved bits to improve the quality of I pictures and P pictures.

Restrictions on frequency of B pictures can make quality loss in B pictures even less noticeable. For example when consecutive progressive B frames in display order are not allowed in a sequence individual progressive B frames will be displayed between two reference frames. If the reference frames are coded with good quality and the motion between the frames can be accurately predicted the progressive B frame will likely be perceived as a good quality frame even if it is coded with a higher QP than the reference frames. Even if the higher QP reduces the quality of the B frame it is likely that the reduction in quality will not be noticeable because of the quality of motion compensated prediction and or because human eyes tend to average the picture quality temporally. An isolated lower quality frame generally will not affect users overall viewing experience when the video is played in real time.

An encoder can make various kinds of adjustments to B pictures to maintain quality in video sequences while keeping bit rate relatively low. For example U.S. patent application Ser. No. 11 400 744 filed Apr. 7 2006 describes a rate control scheme for B pictures that combines quantization step size control with adaptive dead zone control. Another way to adjust B pictures to maintain quality in video sequences while keeping bit rate relatively low is to adjust a difference sometimes referred to as a delta QP between a picture QP for a B picture and a picture QP for an I picture.

As mentioned above an isolated lower quality frame generally will not affect users overall viewing experience over a sequence of frames. Based on this idea techniques and tools for adaptively adjusting picture QPs for predicted pictures e.g. B pictures to help achieve better bit allocation are described. For example an encoder can implement one or more of the following features 

Referring again to the encoder selects a picture type for a current predicted picture. The encoder can use various criteria for selecting picture types although the encoder may have to follow certain rules for selecting picture types in order to be compliant with a decoder. In this example the encoder encodes predicted pictures as P pictures or B pictures.

The encoder selects an initial QP for the current picture based at least in part upon the selected picture type. Typically initial picture QPs for predicted pictures such as B pictures will be higher than initial QPs for I pictures. Then the encoder adaptively selects a delta QP for the current predicted picture. For example the encoder adaptively selects a delta QP for a B picture based on spatial complexity temporal complexity differential quantization status and or other factors. The encoder also can adjust quantization for the current picture in other ways such as by selecting a larger or smaller dead zone or switching between a uniform quantizer and non uniform quantizer.

The encoder quantizes data for the current picture based on the selected delta QP. For example the encoder uses an adjusted QP determined by adjusting the initial QP for the picture by the delta QP for the picture. The encoder can then process other pictures.

For example assume QPis the QP selected by an encoder s rate controller module for a B picture. An adjusted picture QP for a B picture QP can be calculated by adding a delta QP QP to QP 7 . QP can be determined adaptively based on several factors. Generally one possible factor to be considered when determining QP is scene complexity. When scene complexity is low a bigger QP generally can be used for B pictures in the scene without causing noticeable artifacts.

As mentioned above a delta QP can be selected based on many different factors including spatial complexity temporal complexity differential quantization i.e. whether quantization step sizes vary between macroblocks in the picture and whether the picture will be used as reference. In some cases it may be desirable to take all of these factors into consideration. In other cases some subset of these factors and or other factors can be considered.

Spatial complexity can be measured by performing pre encoding analysis of a picture or group of pictures. For example spatial complexity can be measured based on a texture analysis of a picture or group of pictures. Texture analysis can include determining whether high textured smooth or sharp edge features are present. In the case of two pass encoding spatial complexity may be calculated from first pass encoding results using various techniques such as the technique shown in . Spatial complexity is typically considered to be high in high texture pictures for which the delta QP will usually be lower than for low texture pictures. Spatial complexity is typically considered to be low in low texture pictures for which the delta QP will usually be higher than for high texture pictures.

Temporal complexity also can be measured by performing pre encoding analysis of a picture or group of pictures. For example temporal complexity can be measured based on a fast motion search on down sampled frames. In the case of two pass encoding temporal complexity may be calculated from first pass encoding results using various techniques such as the technique shown in . Temporal complexity is typically considered to be high in high motion pictures or other pictures where change over time is significant for which the delta QP will usually be lower than for low temporal complexity pictures.

Differential quantization is a within frame macroblock quantization scheme in which the encoder chooses different QPs for different macroblocks in the same picture which can help to reduce visible artifacts. For example a lower QP may be chosen for macroblocks in smooth regions where quantization artifacts are more likely to be perceived. In this case an encoder can increase a delta QP for the picture since differential quantization will still tend to result in a lower QP in regions that are likely to cause visible artifacts.

Reference picture status for a current picture i.e. whether or not the current picture can be used as a reference picture is usually determined based on picture type. In one implementation progressive B frames and interlaced B frames are not used as reference pictures while B fields can be used as reference pictures specifically the first B field to be decoded in a frame having two B fields is available for use as a reference for the second field to be decoded in the frame. Typically a delta QP for a picture of a type that will not be used as a reference picture will be higher than a delta QP for a picture of a type that will potentially be used as a reference picture.

In the following example an encoder makes a delta QP decision for a B field by looking at temporal complexity differential quantization status and whether the current B field will be used as a reference picture for the other field in the frame. In this example spatial complexity is not separately considered although spatial characteristics may affect temporal complexity for some temporal complexity measures. Specifically in this example AQP is calculated as follows 8 .

The value represented by dis derived from a measure of temporal complexity as shown in Equation 9 below. For a temporal complexity measure C suppose 0

The value represented by dis derived from whether differential quantization is on as shown in Equation 10 below.

The value of dcould take on more than two different values. For example if multi level differential quantization is used dcould take on a different value than where bi level differential quantization is used and dcould take on a third value when differential quantization is not used at all.

The value represented by ddepends on whether the current B field will be used as a reference for the other B field in the same frame as shown in Equation 11 below.

The value of dcould be determined in different ways. For example the value of dcould take on one value if the B field is actually used as a motion compensation reference and take on another value if the B field is not actually used or not available to be used as a motion compensation reference.

In the following example an encoder makes a delta QP decision for a B frame by looking at temporal complexity and differential quantization status. The encoder does not consider whether the current B frame will be used as a reference picture since B frames are never used as motion compensation references. Again spatial complexity is not separately considered although spatial characteristics may affect temporal complexity for some temporal complexity measures. Specifically in this example AQP is calculated as follows 12 .

As noted above alternatively an encoder makes a delta QP decision for B pictures by looking at other combinations of factors. For example an encoder can consider spatial complexity or other factors or omit consideration of factors such as temporal complexity differential quantization status and whether the current B field will be used as a reference picture for the other field in the frame. As another alternative an encoder can adaptively select delta QPs for other predicted pictures e.g. P pictures .

Having described and illustrated the principles of our invention with reference to various described embodiments it will be recognized that the described embodiments can be modified in arrangement and detail without departing from such principles. It should be understood that the programs processes or methods described herein are not related or limited to any particular type of computing environment unless indicated otherwise. Various types of general purpose or specialized computing environments may be used with or perform operations in accordance with the teachings described herein. Elements of the described embodiments shown in software may be implemented in hardware and vice versa.

In view of the many possible embodiments to which the principles of our invention may be applied we claim as our invention all such embodiments as may come within the scope and spirit of the following claims and equivalents thereto.

